<!DOCTYPE html>
F1 - WEEKEND complete

++++++++++++++++++

<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>TOTO</title>
<script src="https://cdn.tailwindcss.com">
// --- Weekend Highlighter Patch ---
function markWeekendCells() {
    document.querySelectorAll("#calendarGrid [data-date], #scrollCalendarContainer [data-date]").forEach(cell => {
        const dateKey = cell.getAttribute("data-date");
        if (!dateKey) return;
        try {
            const d = new Date(dateKey);
            if (d.getDay() === 0 || d.getDay() === 6) {
                cell.classList.add("weekend-cell");
            }
        } catch(e) {}
    });
}

// Run on load and after any refresh
const origRenderCalendar = renderCalendar;
renderCalendar = function() {
    origRenderCalendar.apply(this, arguments);
    markWeekendCells();
};

</script>
<style>
        .control-area { height: 1cm; min-height: 38px; }
        .display-area { height: calc(100vh - 1cm); min-height: calc(100vh - 38px); }
        .priority-1 { background-color: #ef4444; color: white; border-radius: 4px; }
        .priority-2 { background-color: #3b82f6; color: white; border-radius: 4px; }
        .priority-3 { background-color: #fbbf24; color: black; border-radius: 4px; }
        .priority-4 { background-color: #9ca3af; color: white; border-radius: 4px; }
        .calendar-entry { font-size: 9px !important; }
        .calendar-entry span { font-size: 9px !important; }
        #calendarGrid .text-sm { font-size: 10.5px !important; }
        #calendarGrid .text-xs { font-size: 9px !important; }
        #scrollCalendarContainer .text-sm { font-size: 10.5px !important; }
        #scrollCalendarContainer .text-xs { font-size: 9px !important; }
        .grid.grid-cols-7.bg-gray-50 div { font-size: 10.5px !important; }
        #dayModalEntries .text-xs { font-size: 9px !important; }
        #todayEntries .text-xs { font-size: 9px !important; }
        #monthEntries .text-xs { font-size: 9px !important; }
        #importantEntries .text-xs { font-size: 9px !important; }
        .absolute.top-2.right-2 { font-size: 10.5px !important; }
        .card-entries-container { height: 200px; overflow-y: auto; }
        #entryPriority option.priority-1 { background-color: #ef4444; color: white; }
        #entryPriority option.priority-2 { background-color: #3b82f6; color: white; }
        #entryPriority option.priority-3 { background-color: #fbbf24; color: black; }
        #entryPriority option.priority-4 { background-color: #9ca3af; color: white; }
        #entryCategory option.category-personal { background-color: #dbeafe; color: #1e40af; }
        #entryCategory option.category-home { background-color: #dcfce7; color: #166534; }
        #entryCategory option.category-work { background-color: #fef3c7; color: #92400e; }
        #entryCategory option.category-law { background-color: #e9d5ff; color: #7c2d12; }
        #entryCategory option.category-projects { background-color: #fce7f3; color: #be185d; }
        #entryCategory option.category-unassigned { background-color: #ffffff; color: #4b5563; }
        #entryPriority option:hover, #entryPriority option:focus, #entryPriority option:active, #entryCategory option:hover, #entryCategory option:focus, #entryCategory option:active { background-color: inherit !important; color: inherit !important; background: inherit !important; outline: none !important; box-shadow: none !important; }
        #entryPriority option.priority-1:hover, #entryPriority option.priority-1:focus, #entryPriority option.priority-1:active { background-color: #ef4444 !important; color: white !important; background: #ef4444 !important; }
        #entryPriority option.priority-2:hover, #entryPriority option.priority-2:focus, #entryPriority option.priority-2:active { background-color: #3b82f6 !important; color: white !important; background: #3b82f6 !important; }
        #entryPriority option.priority-3:hover, #entryPriority option.priority-3:focus, #entryPriority option.priority-3:active { background-color: #fbbf24 !important; color: black !important; background: #fbbf24 !important; }
        #entryPriority option.priority-4:hover, #entryPriority option.priority-4:focus, #entryPriority option.priority-4:active { background-color: #9ca3af !important; color: white !important; background: #9ca3af !important; }
        #entryCategory option.category-personal:hover, #entryCategory option.category-personal:focus, #entryCategory option.category-personal:active { background-color: #dbeafe !important; color: #1e40af !important; background: #dbeafe !important; }
        #entryCategory option.category-home:hover, #entryCategory option.category-home:focus, #entryCategory option.category-home:active { background-color: #dcfce7 !important; color: #166534 !important; background: #dcfce7 !important; }
        #entryCategory option.category-work:hover, #entryCategory option.category-work:focus, #entryCategory option.category-work:active { background-color: #fef3c7 !important; color: #92400e !important; background: #fef3c7 !important; }
        #entryCategory option.category-law:hover, #entryCategory option.category-law:focus, #entryCategory option.category-law:active { background-color: #e9d5ff !important; color: #7c2d12 !important; background: #e9d5ff !important; }
        #entryCategory option.category-projects:hover, #entryCategory option.category-projects:focus, #entryCategory option.category-projects:active { background-color: #fce7f3 !important; color: #be185d !important; background: #fce7f3 !important; }
        #entryCategory option.category-unassigned:hover, #entryCategory option.category-unassigned:focus, #entryCategory option.category-unassigned:active { background-color: #ffffff !important; color: #4b5563 !important; background: #ffffff !important; }
        #entryPriority:hover, #entryCategory:hover { outline: none !important; }
        #entryPriority.priority-1 { background-color: #ef4444; color: white; }
        #entryPriority.priority-2 { background-color: #3b82f6; color: white; }
        #entryPriority.priority-3 { background-color: #fbbf24; color: black; }
        #entryPriority.priority-4 { background-color: #9ca3af; color: white; }
        #entryCategory.category-personal { background-color: #dbeafe; color: #1e40af; }
        #entryCategory.category-home { background-color: #dcfce7; color: #166534; }
        #entryCategory.category-work { background-color: #fef3c7; color: #92400e; }
        #entryCategory.category-law { background-color: #e9d5ff; color: #7c2d12; }
        #entryCategory.category-projects { background-color: #fce7f3; color: #be185d; }
        #entryCategory.category-unassigned { background-color: #ffffff; color: #4b5563; }
        .dragging-entry .calendar-entry:not(.dragging) { opacity: 0.7; }
        .drop-zone-active { background-color: #dbeafe !important; border: 2px dashed #3b82f6 !important; }
        .drop-zone-hover { background-color: #bfdbfe !important; border: 2px solid #3b82f6 !important; }
        .dragging-card-entry { opacity: 0.5; transform: rotate(2deg); z-index: 1000; }
        .card-drop-zone-active { background-color: #dbeafe !important; border: 2px dashed #3b82f6 !important; transform: scale(1.02); }
        .card-drop-zone-hover { background-color: #bfdbfe !important; border: 2px solid #3b82f6 !important; }
        .dragging-card { opacity: 0.5; transform: rotate(2deg) scale(0.95); z-index: 1000; }
        .card-reorder-drop-zone-active { background-color: #e0f2fe !important; border: 2px dashed #0284c7 !important; transform: scale(1.02); }
        .card-reorder-drop-zone-hover { background-color: #bae6fd !important; border: 2px solid #0284c7 !important; }
        .card-drag-handle { cursor: move; }
        .card-drag-handle:hover { background-color: rgba(0, 0, 0, 0.05); }
        .z-alarm-modal { z-index: 9999 !important; }
        .entry-checked { text-decoration: line-through; }
    .day-alert-yellow { background-color: #fffef1 !important; }
.day-alert-blue { background-color: #ecfaff !important; }

        

        /* Semi-italicized style for all EVENTS entries */
        .event-title,
        .category-events,
        .events,
        .events-entry {
            font-style: oblique 10deg !important;
        }

        .weekend-cell { } /* Tailwind bg-gray-200 */

.weekend-cell { }

div.weekend-cell:not([data-date]) { background-color: #f0f0f0 !important; }
</style>
<script>
        tailwind.config = { theme: { extend: { colors: { primary: '#5D5CDE' } } } }
    </script>

<!-- START TOTO: Compact Days View entries -->
<style>
/* Make entries in Days View as compact as entries in cards */
.day-view .entry-container {
  margin: 2px 0 !important;
  padding: 2px 4px !important;
}
.day-view .entries-container {
  gap: 2px !important; /* in case flex or grid gap is used */
}
</style>
<!-- END TOTO: Compact Days View entries -->


<!-- Compact Day View modal spacing -->
<style>
#dayModalEntries .entry-container,
#dayModalEntries .calendar-entry,
#dayModalEntries > .space-y-3 > * {
  margin: 1px 0 !important;
  padding: 2px 4px !important;
  line-height: 1.05 !important;
  font-size: 11px !important;
}
#dayModalEntries .text-xs { font-size: 9px !important; line-height: 1.05 !important; }
#dayModal .bg-white { padding: 10px !important; }
#dayModal .space-y-3 > * + * { margin-top: 4px !important; }
</style>

<!-- Lighter weekend day cells -->
<style>
#calendarGrid [data-date].weekend-cell,
#scrollCalendarContainer [data-date].weekend-cell { }
</style>

</head>
<body class="bg-white text-gray-900 overflow-hidden">
<!-- EARLY ROBUST INDEXEDDB LOADER -->
<script>
(function(){
  const DB_NAME = 'calendar-persistence-db';
  const STORE = 'state';
  function openDB(){
    return new Promise((res, rej)=>{
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
      };
      req.onsuccess = ()=> res(req.result);
      req.onerror = ()=> res(null);
    });
  }
  async function loadLatest(){
    try{
      const db = await openDB();
      if (!db) return null;
      const tx = db.transaction(STORE, 'readonly');
      const req = tx.objectStore(STORE).get('latest');
      return await new Promise((res, rej)=>{ req.onsuccess = ()=> { try{ res(req.result ? JSON.parse(req.result) : null); }catch(e){ res(null);} }; req.onerror = ()=> res(null); });
    }catch(e){ return null; }
  }
  async function apply(data){
    if (!data) return false;
    try{
      if (data._localStorageFull) {
        for (const k in data._localStorageFull) {
          try { localStorage.setItem(k, data._localStorageFull[k]); } catch(e){}
        }
      }
      if (data.appState !== undefined) window.appState = data.appState;
      if (data.dayAlerts !== undefined) window.dayAlerts = data.dayAlerts;
      if (data.calendarEntries !== undefined) window.calendarEntries = data.calendarEntries;
      if (data.entries !== undefined) window.entries = data.entries;
      window.dispatchEvent(new CustomEvent('auto-state-restored', {detail: data}));
      console.log('Early auto-state restored from IndexedDB');
      return true;
    }catch(e){ console.warn('apply early state failed', e); return false; }
  }
  if (window.indexedDB) {
    loadLatest().then(data=>{ if (data) apply(data); });
  }
})();
</script>

<div class="control-area bg-white flex items-center justify-between px-4 shadow-sm">
<div class="flex items-center space-x-3">
<button class="p-1.5 text-sky-500 bg-sky-100 rounded-lg hover:text-sky-600 transition-colors" id="calendarIcon">
<svg class="h-6 w-6" fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"></path>
</svg>
</button>
<button class="p-1.5 text-gray-600 hover:text-primary transition-colors" id="ideasIcon">
<svg class="h-6 w-6" fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
</svg>
</button>
<div class="h-6 w-px bg-gray-300" style="margin-left: 0.3cm;"></div>
<button class="p-1.5 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors" id="viewToggle" title="Toggle Month/Scroll View">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M4 6h16M4 10h16M4 14h16M4 18h16" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
<div class="flex items-center space-x-3">
<div class="flex items-center" id="monthNavigation">
<button class="p-1 hover:bg-gray-100 rounded transition-colors" id="prevMonth">
<svg class="w-3 h-3" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<h3 class="text-xs font-medium min-w-[80px] text-center mx-1 cursor-pointer hover:bg-gray-100 rounded px-2 py-1 transition-colors" id="currentMonth" title="Go to present month"></h3>
<button class="p-1 hover:bg-gray-100 rounded transition-colors" id="nextMonth">
<svg class="w-3 h-3" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<button class="p-1.5 text-white bg-green-500 rounded-lg hover:bg-green-600 transition-colors" id="addButton">
<svg class="h-4 w-4" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 4v16m8-8H4" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
</div>
<div class="display-area overflow-auto bg-white">
<div class="h-full px-6 pb-6" id="displayContent">
<div class="view-section hidden" id="tasksView">
<div class="mb-6">
<h2 class="text-2xl font-bold mb-4">Tasks</h2>
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
<div class="bg-gray-50 rounded-lg p-4">
<h3 class="font-semibold text-lg mb-3 text-gray-600">To Do</h3>
<div class="space-y-2" id="todoTasks">
<div class="task-item bg-white p-3 rounded-md shadow-sm border border-gray-200">
<div class="flex items-start justify-between">
<div class="flex items-start space-x-2">
<input class="mt-1 rounded border-gray-300" type="checkbox"/>
<span class="text-sm">Review project proposal</span>
</div>
<span class="text-xs text-gray-500">Today</span>
</div>
</div>
</div>
</div>
<div class="bg-blue-50 rounded-lg p-4">
<h3 class="font-semibold text-lg mb-3 text-blue-600">In Progress</h3>
<div class="space-y-2" id="inProgressTasks">
<div class="task-item bg-white p-3 rounded-md shadow-sm border border-blue-200">
<div class="flex items-start justify-between">
<div class="flex items-start space-x-2">
<input class="mt-1 rounded border-gray-300" type="checkbox"/>
<span class="text-sm">Update website design</span>
</div>
<span class="text-xs text-gray-500">Due Tomorrow</span>
</div>
</div>
</div>
</div>
<div class="bg-green-50 rounded-lg p-4">
<h3 class="font-semibold text-lg mb-3 text-green-600">Completed</h3>
<div class="space-y-2" id="completedTasks">
<div class="task-item bg-white p-3 rounded-md shadow-sm border border-green-200 opacity-75">
<div class="flex items-start justify-between">
<div class="flex items-start space-x-2">
<input checked="" class="mt-1 rounded border-gray-300" type="checkbox"/>
<span class="text-sm line-through">Finish quarterly report</span>
</div>
<span class="text-xs text-gray-500">Yesterday</span>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="view-section hidden" id="notesView">
<div class="mb-6">
<div class="grid grid-cols-6 gap-4" id="cardsContainer">
<div class="note-item bg-gray-100 p-3 rounded-lg border border-gray-300">
<div class="flex items-center mb-1 card-drag-handle rounded p-2 -m-2">
<svg class="h-5 w-5 text-blue-600 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
<h3 class="font-semibold text-blue-800">T0</h3>
</div>
<div class="space-y-1 card-entries-container" id="taskEntriesList">
</div>
</div>
<div class="note-item bg-gray-100 p-3 rounded-lg border border-gray-300">
<div class="flex items-center mb-1 card-drag-handle rounded p-2 -m-2">
<svg class="h-5 w-5 text-green-600 mr-2" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
<h3 class="font-semibold text-green-800">E0</h3>
</div>
<div class="space-y-1 card-entries-container" id="eventEntriesList">
</div>
</div>
</div>
</div>
</div>
<div class="view-section" id="calendarView">
<div class="mb-6">
<div class="h-full flex flex-col" id="scrollView">
<div class="grid grid-cols-7 bg-gray-50 border-b border-gray-200 flex-shrink-0 sticky top-0 z-20">
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200">Mon</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200">Tue</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200">Wed</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200">Thu</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200">Fri</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200 weekend-cell">Sat</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 weekend-cell">Sun</div>
</div>
<div class="flex-1 overflow-y-auto overflow-x-hidden">
<div class="pb-6" id="scrollCalendarContainer"></div>
</div>
</div>
<div class="hidden h-full flex flex-col" id="monthView">
<div class="grid grid-cols-7 bg-gray-50 border-b border-gray-200 flex-shrink-0 sticky top-0 z-20">
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200">Mon</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200">Tue</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200">Wed</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200">Thu</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200">Fri</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 border-r border-gray-200 weekend-cell">Sat</div>
<div class="py-1 px-3 text-center text-sm font-medium text-gray-600 weekend-cell">Sun</div>
</div>
<div class="flex-1 overflow-y-auto overflow-x-hidden">
<div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
<div class="grid grid-cols-7" id="calendarGrid"></div>
</div>
</div>
</div>
</div>
</div>
<div class="view-section hidden" id="allView">
<div class="mb-6">
<h2 class="text-2xl font-bold mb-4">All Items</h2>
<div class="space-y-4">
<div class="bg-white p-4 rounded-lg border border-gray-200">
<div class="flex items-center justify-between">
<div class="flex items-center space-x-3">
<span class="w-3 h-3 bg-red-500 rounded-full"></span>
<span class="font-medium">Review project proposal</span>
<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-xs">Task</span>
</div>
<span class="text-sm text-gray-500">Today</span>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="addTaskModal">
<div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
<h3 class="text-lg font-semibold mb-4">Add New Task</h3>
<form id="taskForm">
<div class="mb-4">
<label class="block text-sm font-medium mb-2">Title</label>
<input class="text-base w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="taskTitle" type="text"/>
</div>
<div class="mb-4">
<label class="block text-sm font-medium mb-2">Description</label>
<textarea class="text-base w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="taskDescription" rows="3"></textarea>
</div>
<div class="mb-4">
<label class="block text-sm font-medium mb-2">Due Date</label>
<input class="text-base w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="taskDueDate" type="date"/>
</div>
<div class="flex justify-end space-x-3">
<button class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md" id="cancelTask" type="button">Cancel</button>
<button class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90" type="submit">Add Task</button>
</div>
</form>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="addNoteModal">
<div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
<h3 class="text-lg font-semibold mb-4">Add New Note</h3>
<form id="noteForm">
<div class="mb-4">
<label class="block text-sm font-medium mb-2">Title</label>
<input class="text-base w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="noteTitle" type="text"/>
</div>
<div class="mb-4">
<label class="block text-sm font-medium mb-2">Content</label>
<textarea class="text-base w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="noteContent" rows="5"></textarea>
</div>
<div class="flex justify-end space-x-3">
<button class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-md" id="cancelNote" type="button">Cancel</button>
<button class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary/90" type="submit">Add Note</button>
</div>
</form>
</div>
</div>
<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="welcomeModal">
<div class="bg-white rounded-lg p-4 w-full max-w-lg mx-4 max-h-[80vh] overflow-y-auto">
<div class="text-center mb-4">
<h2 class="text-2xl font-bold text-gray-900">TOTO</h2>
</div>
<div class="space-y-3">
<div>
<h3 class="text-lg font-semibold text-gray-900 mb-2" id="todaySection"></h3>
<div class="space-y-1 mb-2" id="todayEntries"></div>
<hr class="border-gray-200"/>
</div>
<div>
<h3 class="text-lg font-semibold text-gray-900 mb-2" id="monthSection"></h3>
<div class="space-y-1 mb-2" id="monthEntries"></div>
<hr class="border-gray-200"/>
</div>
<div>
<h3 class="text-lg font-semibold text-gray-900 mb-2">IMPORTANT</h3>
<div class="space-y-1 mb-2" id="importantEntries">
<p class="text-gray-500 text-sm italic">No flagged entries yet</p>
</div>
</div>
</div>
<div class="flex justify-center mt-4">
<button class="p-3 bg-green-500 text-white rounded-full hover:bg-green-600 transition-colors" id="closeWelcome" title="Get Started">
<svg class="h-6 w-6" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="dayModal">
<div class="bg-white rounded-lg p-6 w-full max-w-md mx-4 max-h-[80vh] overflow-y-auto relative">
<div class="mb-4">
<h3 class="text-lg font-semibold text-gray-900" id="dayModalTitle"></h3>
</div>
<div class="space-y-3" id="dayModalEntries"></div>
<div class="mt-6 pt-4 border-t border-gray-200">
<div class="flex items-center justify-between">
<button class="w-10 h-10 bg-gray-300 text-gray-700 font-extrabold rounded-md hover:bg-gray-400 transition-colors" id="alertIcon" title="Alert">!</button>
<div class="flex space-x-3">
<button class="flex items-center justify-center w-10 h-10 text-gray-600 hover:bg-gray-100 rounded-md transition-colors" id="addEntryFromDay" title="Close">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
<button class="flex items-center justify-center w-10 h-10 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors" id="closeDayModal" title="Save">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
</div>
</div>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="addCardModal">
<div class="bg-white rounded-lg p-6 w-full max-w-sm mx-4">
<h3 class="text-lg font-semibold mb-6 text-center">Add Card</h3>
<div class="flex justify-center space-x-8 mb-6">
<button class="flex flex-col items-center p-4 rounded-lg hover:bg-gray-50 transition-colors" id="addTaskCard" title="Add Task">
<div class="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mb-2">
<svg class="h-5 w-5 text-blue-600" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</div>
</button>
<button class="flex flex-col items-center p-4 rounded-lg hover:bg-gray-50 transition-colors" id="addEventCard" title="Add Event">
<div class="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mb-2">
<svg class="h-5 w-5 text-green-600" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</div>
</button>
<button class="flex flex-col items-center p-4 rounded-lg hover:bg-gray-50 transition-colors" id="addNoteCard" title="Add Note">
<div class="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mb-2">
<svg class="h-5 w-5 text-purple-600" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</div>
</button>
</div>
<div class="mb-6">
<input class="text-base w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="cardTitle" placeholder="Card Title" type="text"/>
</div>
<div class="flex justify-between items-center">
<div class="hidden" id="addCardImportantContainer">
<label class="flex items-center space-x-2 text-sm">
<input class="rounded border-gray-300" id="addCardImportant" type="checkbox"/>
<span class="text-gray-700">Important</span>
</label>
</div>
<div class="flex space-x-3 ml-auto">
<button class="flex items-center justify-center w-10 h-10 text-gray-600 hover:bg-gray-100 rounded-md transition-colors" id="cancelCardModal" title="Cancel">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
<button aria-disabled="true" class="flex items-center justify-center w-10 h-10 bg-green-500 text-white rounded-md opacity-50 cursor-not-allowed transition-colors" disabled="" id="saveCard" title="Save" type="button">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
</div>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="editCardModal">
<div class="bg-white rounded-lg p-6 w-full max-w-sm mx-4">
<h3 class="text-lg font-semibold mb-6 text-center">Edit Card</h3>
<div class="mb-6">
<input class="text-base w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="editCardTitle" placeholder="Card Title" type="text"/>
</div>
<div class="flex justify-between items-center">
<div class="hidden" id="editCardImportantContainer">
<label class="flex items-center space-x-2 text-sm">
<input class="rounded border-gray-300" id="editCardImportant" type="checkbox"/>
<span class="text-gray-700">Important</span>
</label>
</div>
<div class="flex space-x-3 ml-auto">
<button class="flex items-center justify-center w-10 h-10 text-gray-600 hover:bg-gray-100 rounded-md transition-colors" id="cancelEditCard" title="Cancel">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
<button aria-disabled="true" class="flex items-center justify-center w-10 h-10 bg-green-500 text-white rounded-md opacity-50 cursor-not-allowed transition-colors" disabled="" id="saveEditCard" title="Save" type="button">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
</div>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="alarmNotificationModal">
<div class="bg-white rounded-lg p-6 w-full max-w-sm mx-4 border-4 border-red-500 shadow-2xl">
<div class="text-center mb-6">
<div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
<svg class="h-8 w-8 text-red-600" fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12,20A7,7 0 0,1 5,13A7,7 0 0,1 12,6A7,7 0 0,1 19,13A7,7 0 0,1 12,20M19.03,7.39L20.45,5.97C20,5.46 19.55,5 19.04,4.56L17.62,6C16.07,4.74 14.12,4 12,4A9,9 0 0,0 3,13A9,9 0 0,0 12,22C17,22 21,17.97 21,13C21,10.88 20.26,8.93 19.03,7.39M11,14H13V8H11M15,1H9V3H15V1Z"></path>
</svg>
</div>
<h3 class="text-lg font-bold text-gray-900 mb-2">ALARM</h3>
<div class="text-base font-semibold text-gray-800 mb-2" id="alarmEntryTitle"></div>
<div class="text-sm text-gray-600 mb-4" id="alarmEntryDateTime"></div>
</div>
<div class="flex justify-center">
<button class="px-8 py-3 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600 transition-colors focus:outline-none focus:ring-2 focus:ring-red-500" id="alarmOkButton">
                    OK
                </button>
</div>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-alarm-modal" id="setAlarmModal">
<div class="bg-white rounded-lg p-4 w-full max-w-md mx-3">
<div class="flex items-center justify-between mb-4">
<h3 class="text-base font-semibold">Set Alarm</h3>
</div>
<div class="mb-4">
<div class="text-sm text-gray-600" id="alarmEntryTitleDisplay">
</div>
</div>
<div class="mb-4 flex space-x-2">
<div class="relative" style="width: 60%">
<label class="block text-sm font-medium mb-2">Alarm Date</label>
<input class="opacity-0 absolute inset-0 w-full h-full pointer-events-none z-10" id="customAlarmDateInput" type="date"/>
<div class="text-base w-full border border-gray-300 rounded-md bg-white cursor-pointer hover:bg-gray-50 transition-colors relative z-20 flex items-center" id="customAlarmDateDisplay">
<div class="flex items-center justify-center w-10 h-full border-r border-gray-200 bg-red-50">
<svg class="h-5 w-5 text-red-600" fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"></path>
</svg>
</div>
<span class="px-3 py-2 flex-1 text-center">Select Alarm Date</span>
</div>
<div class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 w-72" id="customAlarmDatePicker">
<div class="p-3 border-b border-gray-200 flex items-center justify-between">
<button class="p-1 hover:bg-gray-100 rounded" id="prevCustomAlarmPickerMonth" type="button">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<h4 class="font-semibold text-sm" id="customAlarmPickerMonth"></h4>
<button class="p-1 hover:bg-gray-100 rounded" id="nextCustomAlarmPickerMonth" type="button">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="p-3">
<div class="grid grid-cols-7 gap-1 mb-2">
<div class="text-center text-xs font-medium text-gray-500 py-1">Mo</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Tu</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">We</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Th</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Fr</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Sa</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Su</div>
</div>
<div class="grid grid-cols-7 gap-1" id="customAlarmPickerCalendarGrid"></div>
</div>
</div>
</div>
<div class="relative" style="width: 40%">
<label class="block text-sm font-medium mb-2">Alarm Time</label>
<div class="absolute left-3 top-9 transform pointer-events-none">
<svg class="h-4 w-4 text-red-600" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</div>
<select class="text-base w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="customAlarmTime"></select>
</div>
</div>
<div class="flex justify-end space-x-3">
<button class="flex items-center justify-center w-10 h-10 text-gray-600 hover:bg-gray-100 rounded-md transition-colors" id="cancelCustomAlarm" title="Cancel" type="button">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
<button class="flex items-center justify-center w-10 h-10 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors" id="saveCustomAlarm" title="Save" type="button">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
</div>
</div>
<div class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" id="addEntryModal">
<div class="bg-white rounded-lg p-4 w-full max-w-md mx-3">
<div class="flex items-center justify-between mb-3">
<h3 class="text-base font-semibold" id="modalTitle">Add Entry</h3>
<div class="flex items-center space-x-2">
<button class="px-2 py-1 rounded-lg transition-colors text-blue-600" id="taskModeBtn" title="Task Mode" type="button">
<svg class="h-7 w-7" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
<button class="px-2 py-1 rounded-lg transition-colors text-gray-400 hover:text-gray-600 hover:bg-gray-100" id="eventModeBtn" title="Event Mode" type="button">
<svg class="h-7 w-7" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
</div>
<div class="mb-4 flex justify-start space-x-2">
<button class="px-2 py-1 rounded-lg transition-colors text-gray-400 hover:text-gray-600 hover:bg-gray-100" id="pinModeBtn" title="Pin Mode (Off)" type="button">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" stroke-linecap="round" stroke-linejoin="round"></path>
<path d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
<button class="px-2 py-1 rounded-lg transition-colors text-gray-400 hover:text-gray-600 hover:bg-gray-100" id="lockModeBtn" title="Lock Mode (Off)" type="button">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
<button class="px-2 py-1 rounded-lg transition-colors text-gray-400 hover:text-gray-600 hover:bg-gray-100" id="checkModeBtn" title="Check Mode (Off)" type="button">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
<form id="entryForm">
<div class="mb-4">
<input class="text-base w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="entryTitle" placeholder="Title" type="text"/>
</div>
<div class="mb-4">
<textarea class="text-base w-full px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="entryDescription" placeholder="Details" rows="3"></textarea>
</div>
<div class="mb-3 flex space-x-2">
<div class="relative" style="width: 60%">
<input class="opacity-0 absolute inset-0 w-full h-full pointer-events-none z-10" id="entryDate" type="date"/>
<div class="text-base w-full border border-gray-300 rounded-md bg-white cursor-pointer hover:bg-gray-50 transition-colors relative z-20 flex items-center" id="dateDisplay">
<div class="flex items-center justify-center w-10 h-full border-r border-gray-200 bg-blue-50">
<svg class="h-5 w-5 text-blue-600" fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"></path>
</svg>
</div>
<span class="px-3 py-2 flex-1 text-center">Select Date</span>
</div>
<div class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 w-72" id="customDatePicker">
<div class="p-3 border-b border-gray-200 flex items-center justify-between">
<button class="p-1 hover:bg-gray-100 rounded" id="prevPickerMonth" type="button">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<h4 class="font-semibold text-sm" id="pickerMonth"></h4>
<button class="p-1 hover:bg-gray-100 rounded" id="nextPickerMonth" type="button">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="p-3">
<div class="grid grid-cols-7 gap-1 mb-2">
<div class="text-center text-xs font-medium text-gray-500 py-1">Mo</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Tu</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">We</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Th</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Fr</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Sa</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Su</div>
</div>
<div class="grid grid-cols-7 gap-1" id="pickerCalendarGrid"></div>
</div>
</div>
</div>
<div class="relative" style="width: 40%">
<div class="absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
<svg class="h-4 w-4 text-blue-600" fill="none" stroke="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</div>
<select class="text-base w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="entryTime"></select>
</div>
</div>
<div class="mb-4 flex space-x-2">
<div class="relative" style="width: 50%">
<div class="absolute left-3 top-1/2 transform -translate-y-1/2 pointer-events-none">
<svg class="h-4 w-4 text-red-600" fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M12,20A7,7 0 0,1 5,13A7,7 0 0,1 12,6A7,7 0 0,1 19,13A7,7 0 0,1 12,20M19.03,7.39L20.45,5.97C20,5.46 19.55,5 19.04,4.56L17.62,6C16.07,4.74 14.12,4 12,4A9,9 0 0,0 3,13A9,9 0 0,0 12,22C17,22 21,17.97 21,13C21,10.88 20.26,8.93 19.03,7.39M11,14H13V8H11M15,1H9V3H15V1Z"></path>
</svg>
</div>
<select class="text-base w-full pl-10 pr-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="alarmOptions">
<option value="none">None</option>
<option value="same_day">Same day</option>
<option selected="" value="1_day_before">1 day before</option>
<option value="2_days_before">2 days before</option>
<option value="3_days_before">3 days before</option>
<option value="1_week_before">1 week before</option>
<option value="1_month_before">1 month before</option>
<option value="custom">Custom</option>
</select>
</div>
<div class="flex items-center" style="width: 50%">
<span class="text-gray-600 text-sm px-3 py-2" id="alarmDisplayText">none</span>
</div>
</div>
<div class="mb-4 hidden" id="customAlarmContainer">
<div class="relative">
<input class="opacity-0 absolute inset-0 w-full h-full pointer-events-none z-10" id="alarmDate" type="date"/>
<div class="text-base w-full border border-gray-300 rounded-md bg-white cursor-pointer hover:bg-gray-50 transition-colors relative z-20 flex items-center" id="alarmDateDisplay">
<div class="flex items-center justify-center w-10 h-full border-r border-gray-200 bg-red-50">
<svg class="h-5 w-5 text-red-600" fill="currentColor" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"></path>
</svg>
</div>
<span class="px-3 py-2 flex-1 text-center">Custom Alarm Date</span>
</div>
<div class="hidden absolute top-full left-0 mt-1 bg-white border border-gray-300 rounded-lg shadow-lg z-50 w-72" id="alarmCustomDatePicker">
<div class="p-3 border-b border-gray-200 flex items-center justify-between">
<button class="p-1 hover:bg-gray-100 rounded" id="prevAlarmPickerMonth" type="button">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M15 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
<h4 class="font-semibold text-sm" id="alarmPickerMonth"></h4>
<button class="p-1 hover:bg-gray-100 rounded" id="nextAlarmPickerMonth" type="button">
<svg class="w-4 h-4" fill="none" stroke="currentColor" viewbox="0 0 24 24">
<path d="M9 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
</svg>
</button>
</div>
<div class="p-3">
<div class="grid grid-cols-7 gap-1 mb-2">
<div class="text-center text-xs font-medium text-gray-500 py-1">Mo</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Tu</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">We</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Th</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Fr</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Sa</div>
<div class="text-center text-xs font-medium text-gray-500 py-1">Su</div>
</div>
<div class="grid grid-cols-7 gap-1" id="alarmPickerCalendarGrid"></div>
</div>
</div>
</div>
</div>
<div class="mb-6 flex space-x-2">
<select class="text-base px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="entryPriority" style="width: 20%">
<option class="priority-1" value="1">1</option>
<option class="priority-2" value="2">2</option>
<option class="priority-3" value="3">3</option>
<option class="priority-4" selected="" value="4">4</option>
</select>
<select class="text-base px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="entryCategory" style="width: 50%">
<option class="category-personal" value="personal">Personal</option>
<option class="category-home" value="home">Home</option>
<option class="category-work" selected="" value="work">Work</option>
<option class="category-law" value="law">Law</option>
<option class="category-projects" value="projects">Projects</option>
<option class="category-unassigned" value="unassigned">Unassigned</option>
</select>
<select class="text-base px-3 py-2 border border-gray-300 rounded-md bg-white focus:outline-none focus:ring-2 focus:ring-primary" id="entryCard" style="width: 30%">
<option value="">Card</option>
</select>
</div>
<div class="relative flex justify-end items-center">
<button class="absolute left-0 flex items-center justify-center w-10 h-10 text-gray-400 rounded-md cursor-not-allowed" disabled="" id="deleteEntry" title="Delete (Unlock required)" type="button">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
<div class="flex space-x-3">
<button class="flex items-center justify-center w-10 h-10 text-gray-600 hover:bg-gray-100 rounded-md transition-colors" id="cancelEntry" title="Cancel" type="button">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
<button class="flex items-center justify-center w-10 h-10 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors" id="saveEntry" title="Save" type="submit">
<svg class="h-5 w-5" fill="none" stroke="currentColor" stroke-width="2" viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
<path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"></path>
</svg>
</button>
</div>
</div>
</form>
</div>
</div>
<script>
        const viewSections = document.querySelectorAll('.view-section');
        const addTaskModal = document.getElementById('addTaskModal');
        const addNoteModal = document.getElementById('addNoteModal');
        const addEntryModal = document.getElementById('addEntryModal');
        const calendarIcon = document.getElementById('calendarIcon');
        const ideasIcon = document.getElementById('ideasIcon');
        const viewToggle = document.getElementById('viewToggle');
        const scrollView = document.getElementById('scrollView');
        const monthView = document.getElementById('monthView');
        let currentDate = new Date(), isScrollView = true, selectedDate = null, currentEntryMode = 'task';

        function updateCurrentMonthLabel() {
          const el = document.getElementById('currentMonth');
          if (!el) return;
          const d = currentDate;
          const monthName = d.toLocaleString(undefined, { month: 'short' });
          el.textContent = monthName + ' ' + d.getFullYear();
        }

        let calendarEntries = [], cards = [], editingEntry = null, originalEntryData = null, isEditMode = false;
        let isPinModeActive = false;
        let isLockModeActive = false;
        let isCheckModeActive = false;
        let pickerCurrentDate = new Date(), alarmPickerCurrentDate = new Date();
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        const fullMonthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
        let longPressTimer = null;
        let isLongPress = false;
        let currentLongPressDate = null;
        let editingCard = null;
        let db = null;

function applyDayAlertEffects() {
    document.querySelectorAll("#calendarGrid [data-date], #scrollCalendarContainer [data-date]").forEach(cell => {
        const dateKey = cell.getAttribute("data-date");
        if (!dateKey) return;
        cell.classList.remove("day-alert-yellow");
        cell.classList.remove("day-alert-blue");
        if (dayAlerts[dateKey] === 1) {
            cell.classList.add("day-alert-yellow");
        }
        else if (dayAlerts[dateKey] === 2) {
            cell.classList.add("day-alert-blue");
        }
    });
}

        const DB_NAME = 'TOTOCalendar';
        const DB_VERSION = 1;
        const STORE_NAME = 'entries';

// NEW
let dayAlerts = {};  // { "2025-09-30": 2, "2025-10-01": 1 }

function loadDayAlertsFromLocalStorage() {
    try {
        const raw = localStorage.getItem('TOTO_dayAlerts');
        if (raw) {
            const parsed = JSON.parse(raw);
            if (parsed && typeof parsed === 'object') dayAlerts = parsed;
        }

// Apply effects initially
applyDayAlertEffects();
    } catch (e) { dayAlerts = {}; }
}
function saveDayAlertsToLocalStorage() {
    try {
        localStorage.setItem('TOTO_dayAlerts', JSON.stringify(dayAlerts));
    } catch (e) { /* ignore */ }
}

// Exclamation button toggle (3 states)
const alertIcon = document.getElementById("alertIcon");
const closeDayModalBtn = document.getElementById("closeDayModal");
let alertState = 0; // current state
let initialAlertState = 0; // state when modal opened

function updateAlertIcon() {
    alertIcon.className = "w-10 h-10 font-extrabold rounded-md transition-colors";
    if (alertState === 0) {
        alertIcon.classList.add("bg-gray-300", "text-gray-700", "hover:bg-gray-400");
    } else if (alertState === 1) {
        alertIcon.classList.add("bg-yellow-200", "text-yellow-700", "hover:bg-yellow-300");
    } else if (alertState === 2) {
        alertIcon.classList.add("bg-blue-200", "text-blue-700", "hover:bg-blue-300");
    }
    alertIcon.textContent = "!";
    // Enable/disable SAVE strictly
    if (alertState !== initialAlertState) {
        closeDayModalBtn.disabled = false;
        closeDayModalBtn.classList.remove("opacity-50", "cursor-not-allowed");
    } else {
        closeDayModalBtn.disabled = true;
        closeDayModalBtn.classList.add("opacity-50", "cursor-not-allowed");
    }
}

alertIcon.addEventListener("click", () => {
    alertState = (alertState + 1) % 3; // cycle states
    updateAlertIcon();
});

if (closeDayModalBtn) {
    closeDayModalBtn.addEventListener("click", () => {
        if (typeof currentLongPressDate !== 'undefined' && currentLongPressDate) {
            const dateKey = currentLongPressDate;
            dayAlerts[dateKey] = alertState;
            saveDayAlertsToLocalStorage();
            applyDayAlertEffects();
        }
        document.getElementById("dayModal").classList.add("hidden");
    });
}

// When opening modal, set initialAlertState = stored state, alertState = same
// Then call updateAlertIcon() to sync



        function isDateBeforeToday(dateStr) {
            const entryDate = new Date(dateStr + 'T00:00:00');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            return entryDate < today;
        }

        async function initStorage() {
            try {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = () => { resolve(false); };
                    request.onsuccess = () => { db = request.result; resolve(true); };
                    request.onupgradeneeded = (event) => {
                        db = event.target.result;
                        if (!db.objectStoreNames.contains(STORE_NAME)) {
                            const store = db.createObjectStore(STORE_NAME, { keyPath: 'id' });
                            store.createIndex('date', 'date', { unique: false });
                        }
                    };
                });
            } catch (error) {
                return false;
            }
        }

        async function saveToStorage() {
            if (!db) {
                try {
                    const data = JSON.stringify({
                        entries: calendarEntries,
                        cards: cards,
                        settings: {
                            currentDate: currentDate.toISOString(),
                            isScrollView: isScrollView,
                            currentEntryMode: currentEntryMode,
                            dayAlerts: dayAlerts
                        }
                    });
                    const chunks = [];
                    const chunkSize = 3000;
                    for (let i = 0; i < data.length; i += chunkSize) {
                        chunks.push(data.slice(i, i + chunkSize));
                    }
                    for (let i = 0; i < 50; i++) {
                        document.cookie = `toto_chunk_${i}=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;`;
                    }
                    chunks.forEach((chunk, index) => {
                        document.cookie = `toto_chunk_${index}=${encodeURIComponent(chunk)}; expires=Fri, 31 Dec 2099 23:59:59 UTC; path=/;`;
                    });
                    document.cookie = `toto_chunks=${chunks.length}; expires=Fri, 31 Dec 2099 23:59:59 UTC; path=/;`;
                } catch (error) {}
                return;
            }

            try {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                await new Promise((resolve, reject) => {
                    const clearRequest = store.clear();
                    clearRequest.onsuccess = () => resolve();
                    clearRequest.onerror = () => reject(clearRequest.error);
                });
                
                for (const entry of calendarEntries) {
                    await new Promise((resolve, reject) => {
                        const addRequest = store.add(entry);
                        addRequest.onsuccess = () => resolve();
                        addRequest.onerror = () => reject(addRequest.error);
                    });
                }
                
                for (const card of cards) {
                    await new Promise((resolve, reject) => {
                        const addRequest = store.add(card);
                        addRequest.onsuccess = () => resolve();
                        addRequest.onerror = () => reject(addRequest.error);
                    });
                }
                
                const settings = {
                    id: 'settings',
                    currentDate: currentDate.toISOString(),
                    isScrollView: isScrollView,
                    currentEntryMode: currentEntryMode,
                            dayAlerts: dayAlerts
                };
                await new Promise((resolve, reject) => {
                    const addRequest = store.add(settings);
                    addRequest.onsuccess = () => resolve();
                    addRequest.onerror = () => reject(addRequest.error);
                });
                
            } catch (error) {}
        }

        async function loadFromStorage() {
            if (!db) {
                try {
                    const getCookie = (name) => {
                        const value = `; ${document.cookie}`;
                        const parts = value.split(`; ${name}=`);
                        if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
                        return null;
                    };
                    
                    const chunkCount = parseInt(getCookie('toto_chunks') || '0');
                    if (chunkCount > 0) {
                        let data = '';
                        for (let i = 0; i < chunkCount; i++) {
                            const chunk = getCookie(`toto_chunk_${i}`);
                            if (chunk) data += chunk;
                        }
                        
                        if (data) {
                            const parsed = JSON.parse(data);
                            if (parsed.entries) { calendarEntries = parsed.entries; }
                            if (parsed.cards) { cards = parsed.cards; }
                            if (parsed.settings) {
                                if (parsed.settings.currentDate) { currentDate = new Date(parsed.settings.currentDate); }
                                if (typeof parsed.settings.isScrollView === 'boolean') { isScrollView = parsed.settings.isScrollView; }
                                if (parsed.settings.currentEntryMode) { currentEntryMode = parsed.settings.currentEntryMode; }
                            }
                            return true;
                        }
                    }
                } catch (error) {}
                return false;
            }

            try {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                
                return new Promise((resolve, reject) => {
                    const request = store.getAll();
                    request.onsuccess = () => {
                        const results = request.result;
                        const settings = results.find(item => item.id === 'settings');
                        const entries = results.filter(item => item.id !== 'settings' && !item.id.toString().startsWith('card_'));
                        const savedCards = results.filter(item => item.id.toString().startsWith('card_'));
                        
                        if (entries.length > 0) { calendarEntries = entries; }
                        if (savedCards.length > 0) { cards = savedCards; }
                        
                        if (settings) {
                            if (settings.currentDate) { currentDate = new Date(settings.currentDate); }
                            if (typeof settings.isScrollView === 'boolean') { isScrollView = settings.isScrollView; }
                            if (settings.currentEntryMode) { currentEntryMode = settings.currentEntryMode; }
                        }
                        
                        resolve(true);
                    };
                    request.onerror = () => { resolve(false); };
                });
            } catch (error) {
                return false;
            }
        }

        function initializeDefaultCards() {}

        function populateCardDropdown() {
            const cardSelect = document.getElementById('entryCard');
            const currentMode = currentEntryMode;
            
            cardSelect.innerHTML = '';
            
            if (currentMode === 'task') {
                const t0Option = document.createElement('option');
                t0Option.value = 'T0';
                t0Option.textContent = 'T0';
                cardSelect.appendChild(t0Option);
            } else if (currentMode === 'event') {
                const e0Option = document.createElement('option');
                e0Option.value = 'E0';
                e0Option.textContent = 'E0';
                cardSelect.appendChild(e0Option);
            }
            
            const relevantCards = cards.filter(card => 
                card.type === currentMode && 
                card.title !== 'T0' && 
                card.title !== 'E0'
            );
            
            relevantCards.forEach(card => {
                const option = document.createElement('option');
                option.value = card.title;
                option.textContent = card.title;
                cardSelect.appendChild(option);
            });
            
            if (currentMode === 'task') {
                cardSelect.value = 'T0';
            } else if (currentMode === 'event') {
                cardSelect.value = 'E0';
            }
        }

        function calculateAlarmDate(entryDate, alarmOption) {
            if (!entryDate || alarmOption === 'none') { return ''; }
            
            const baseDate = new Date(entryDate + 'T12:00:00');
            let alarmDate = new Date(baseDate);
            
            switch (alarmOption) {
                case 'same_day': break;
                case '1_day_before': alarmDate.setDate(alarmDate.getDate() - 1); break;
                case '2_days_before': alarmDate.setDate(alarmDate.getDate() - 2); break;
                case '3_days_before': alarmDate.setDate(alarmDate.getDate() - 3); break;
                case '1_week_before': alarmDate.setDate(alarmDate.getDate() - 7); break;
                case '1_month_before': alarmDate.setMonth(alarmDate.getMonth() - 1); break;
                case 'custom': return '';
                default: return '';
            }
            
            return alarmDate.toISOString().split('T')[0];
        }

        function updateAlarmOptionsDisplay(isUserInteraction = true) {
            const alarmOptions = document.getElementById('alarmOptions');
            const customContainer = document.getElementById('customAlarmContainer');
            const entryDate = document.getElementById('entryDate').value;
            
            if (alarmOptions.value === 'custom') {
                if (isUserInteraction) {
                    alarmOptions.dataset.previousValue = alarmOptions.dataset.previousValue || '1_day_before';
                    openSetAlarmModal();
                } else {
                    customContainer.classList.add('hidden');
                }
            } else {
                customContainer.classList.add('hidden');
                const calculatedDate = calculateAlarmDate(entryDate, alarmOptions.value);
                document.getElementById('alarmDate').value = calculatedDate;
                const alarmDateInput = document.getElementById('alarmDate');
                if (alarmDateInput) { delete alarmDateInput.dataset.customAlarmTime; }
                updateAlarmDateDisplay();
                alarmOptions.dataset.previousValue = alarmOptions.value;
            }
            
            updateAlarmDisplay();
        }

        function updateAlarmDisplay() {
            const alarmOptions = document.getElementById('alarmOptions').value;
            const entryTime = document.getElementById('entryTime').value;
            const entryDate = document.getElementById('entryDate').value;
            const alarmDisplayText = document.getElementById('alarmDisplayText');
            
            let displayText = 'none';
            
            if (alarmOptions === 'none') {
                displayText = 'none';
            } else if (alarmOptions === 'custom') {
                const customAlarmDate = document.getElementById('alarmDate').value;
                const alarmDateInput = document.getElementById('alarmDate');
                const customAlarmTime = alarmDateInput ? alarmDateInput.dataset.customAlarmTime : null;
                
                if (customAlarmDate && customAlarmTime) {
                    const alarmDate = new Date(customAlarmDate + 'T00:00:00');
                    const day = alarmDate.getDate();
                    const month = monthNames[alarmDate.getMonth()];
                    const year = alarmDate.getFullYear();
                    const time12Hour = formatTime12Hour(customAlarmTime);
                    displayText = `${day} ${month} ${year}, ${time12Hour}`;
                } else {
                    displayText = 'as set';
                }
            } else {
                const calculatedAlarmDate = calculateAlarmDate(entryDate, alarmOptions);
                if (calculatedAlarmDate) {
                    const alarmDate = new Date(calculatedAlarmDate + 'T00:00:00');
                    const day = alarmDate.getDate();
                    const month = monthNames[alarmDate.getMonth()];
                    const year = alarmDate.getFullYear();
                    displayText = `${day} ${month} ${year}, 6:00 am`;
                } else {
                    displayText = 'none';
                }
            }
            
            alarmDisplayText.textContent = displayText;
        }

        function formatTime12Hour(time24) {
            const [hour, minute] = time24.split(':');
            let hour12 = parseInt(hour);
            const ampm = hour12 >= 12 ? 'pm' : 'am';
            if (hour12 === 0) hour12 = 12;
            else if (hour12 > 12) hour12 -= 12;
            return `${hour12}:${minute} ${ampm}`;
        }

        document.getElementById('alarmOptions').addEventListener('change', () => {
            updateAlarmOptionsDisplay(true);
            updateSaveButtonState();
        });

        document.getElementById('alarmOptions').addEventListener('click', (e) => {
            if (e.target.tagName === 'OPTION' && e.target.value === 'custom') {
                setTimeout(() => { openSetAlarmModal(); }, 50);
            }
        });

        let previousAlarmValue = document.getElementById('alarmOptions').value;
        
        document.getElementById('alarmOptions').addEventListener('focus', () => {
            previousAlarmValue = document.getElementById('alarmOptions').value;
        });

        document.getElementById('alarmOptions').addEventListener('blur', () => {
            const currentValue = document.getElementById('alarmOptions').value;
            if (currentValue === 'custom' && previousAlarmValue !== 'custom') {
                setTimeout(() => { openSetAlarmModal(); }, 10);
            }
            previousAlarmValue = currentValue;
        });

        document.getElementById('entryDate').addEventListener('change', () => {
            updateDateDisplay();
            const alarmOptions = document.getElementById('alarmOptions');
            if (alarmOptions.value !== 'custom') {
                const calculatedDate = calculateAlarmDate(document.getElementById('entryDate').value, alarmOptions.value);
                document.getElementById('alarmDate').value = calculatedDate;
                const alarmDateInput = document.getElementById('alarmDate');
                if (alarmDateInput) { delete alarmDateInput.dataset.customAlarmTime; }
                updateAlarmDateDisplay();
            }
            updateAlarmDisplay();
            updateSaveButtonState();
        });

        document.getElementById('entryDate').addEventListener('input', () => { updateSaveButtonState(); });
        document.getElementById('entryTime').addEventListener('change', () => { updateAlarmDisplay(); updateSaveButtonState(); });

        document.getElementById('cancelTask').addEventListener('click', () => {
            addTaskModal.classList.add('hidden');
            document.getElementById('taskForm').reset();
        });
        document.getElementById('cancelNote').addEventListener('click', () => {
            addNoteModal.classList.add('hidden');
            document.getElementById('noteForm').reset();
        });
        document.getElementById('cancelEntry').addEventListener('click', () => {
            addEntryModal.classList.add('hidden');
            document.getElementById('entryForm').reset();
            selectedDate = null;
            updateSaveButtonState();
        });
        
        addTaskModal.addEventListener('click', (e) => {
            if (e.target === addTaskModal) {
                addTaskModal.classList.add('hidden');
                document.getElementById('taskForm').reset();
            }
        });
        addNoteModal.addEventListener('click', (e) => {
            if (e.target === addNoteModal) {
                addNoteModal.classList.add('hidden');
                document.getElementById('noteForm').reset();
            }
        });
        addEntryModal.addEventListener('click', (e) => {
            if (e.target === addEntryModal) {
                addEntryModal.classList.add('hidden');
                document.getElementById('entryForm').reset();
                selectedDate = null;
            }
        });

        document.getElementById('taskForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const dueDate = document.getElementById('taskDueDate').value;
            if (title.trim()) {
                addTaskModal.classList.add('hidden');
                document.getElementById('taskForm').reset();
                addTaskToUI(title, description, dueDate);
            }
        });
        document.getElementById('noteForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;
            if (title.trim()) {
                addNoteModal.classList.add('hidden');
                document.getElementById('noteForm').reset();
                addNoteToUI(title, content);
            }
        });
        document.getElementById('entryForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('entryTitle').value;
            const description = document.getElementById('entryDescription').value;
            const date = document.getElementById('entryDate').value;
            const time = document.getElementById('entryTime').value;
            const alarmOptions = document.getElementById('alarmOptions').value;
            const alarmDate = document.getElementById('alarmDate').value;
            const priority = document.getElementById('entryPriority').value;
            const category = document.getElementById('entryCategory').value;
            const card = document.getElementById('entryCard').value;
            
            const alarmDateInput = document.getElementById('alarmDate');
            const customAlarmTime = alarmDateInput ? alarmDateInput.dataset.customAlarmTime : null;
            
            if (title.trim()) {
                if (isEditMode && editingEntry) {
                    const index = calendarEntries.findIndex(entry => entry.id === editingEntry.id);
                    if (index !== -1) {
                        calendarEntries[index] = {
                            ...editingEntry,
                            title: title.trim(),
                            description: description.trim(),
                            date: date,
                            time: time,
                            alarmOptions: alarmOptions,
                            alarmDate: alarmDate,
                            alarmTime: customAlarmTime || null,
                            priority: priority,
                            category: category,
                            card: card,
                            mode: currentEntryMode,
                            pinned: isPinModeActive,
                            locked: isLockModeActive,
                            checked: isCheckModeActive
                        };
                    }
                } else {
                    const entryData = {
                        id: Date.now() + Math.random(),
                        title: title.trim(),
                        description: description.trim(),
                        date: date,
                        time: time,
                        alarmOptions: alarmOptions,
                        alarmDate: alarmDate,
                        alarmTime: customAlarmTime || null,
                        priority: priority,
                        category: category,
                        card: card,
                        mode: currentEntryMode,
                        pinned: isPinModeActive,
                        locked: isLockModeActive,
                        checked: isCheckModeActive
                    };
                    calendarEntries.push(entryData);
                }
                
                refreshCalendarDisplay();
                addEntryModal.classList.add('hidden');
                document.getElementById('entryForm').reset();
                selectedDate = null;
                isEditMode = false;
                editingEntry = null;
                originalEntryData = null;
                updateSaveButtonState();
                
                saveToStorage();
            }
        });

        document.getElementById('deleteEntry').addEventListener('click', () => {
            if (isEditMode && editingEntry && !document.getElementById('deleteEntry').disabled) { 
                showDeleteConfirmation(); 
            }
        });

        function showDeleteConfirmation() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900">Delete ${editingEntry.title}</h3>
                    <div class="flex justify-end space-x-3">
                        <button class="flex items-center justify-center w-10 h-10 text-gray-600 hover:bg-gray-100 rounded-md transition-colors cancel-delete" title="Cancel">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <button class="flex items-center justify-center w-10 h-10 bg-red-500 text-white hover:bg-red-600 rounded-md transition-colors confirm-delete" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            modal.querySelector('.cancel-delete').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            modal.querySelector('.confirm-delete').addEventListener('click', () => {
                deleteEntry();
                document.body.removeChild(modal);
            });
            modal.addEventListener('click', (e) => {
                if (e.target === modal) { document.body.removeChild(modal); }
            });
            document.body.appendChild(modal);
        }

        function deleteEntry() {
            if (isEditMode && editingEntry) {
                const index = calendarEntries.findIndex(entry => entry.id === editingEntry.id);
                if (index !== -1) {
                    calendarEntries.splice(index, 1);
                    refreshCalendarDisplay();
                }
                addEntryModal.classList.add('hidden');
                document.getElementById('entryForm').reset();
                isEditMode = false;
                editingEntry = null;
                originalEntryData = null;
                selectedDate = null;
                
                saveToStorage();
            }
        }

        document.getElementById('addButton').addEventListener('click', () => {
            const notesView = document.getElementById('notesView');
            if (!notesView.classList.contains('hidden')) {
                selectedCardType = 'task';
                document.getElementById('cardTitle').value = '';
                forceTaskSelection();
                document.getElementById('addCardModal').classList.remove('hidden');
                setTimeout(() => { forceTaskSelection(); }, 50);
            } else {
                resetModalForAdd();
                addEntryModal.classList.remove('hidden');
            }
        });

        function resetModalForAdd() {
            isEditMode = false;
            editingEntry = null;
            originalEntryData = null;
            document.getElementById('modalTitle').textContent = 'Add Entry';
            
            const saveButton = document.getElementById('saveEntry');
            saveButton.disabled = true;
            saveButton.className = "flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed";
            
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
            document.getElementById('alarmOptions').value = '1_day_before';
            updateAlarmOptionsDisplay();
            updateDateDisplay();
            document.getElementById('entryTime').value = '08:00';
            updateAlarmDisplay();
            
            // Always default PIN to OFF for new entries
            isPinModeActive = false;
            updatePinModeDisplay();
            
            // Always default LOCK to OFF for new entries
            isLockModeActive = false;
            updateLockModeDisplay();
            
            // Always default CHECK to OFF for new entries
            isCheckModeActive = false;
            updateCheckModeDisplay();
            
            currentEntryMode = 'task';
            updateEntryModeDisplay();
            populateCardDropdown();
            
            document.getElementById('entryPriority').value = '4';
            document.getElementById('entryCategory').value = 'work';
            updatePriorityStyling();
            updateCategoryStyling();
            
            updateSaveButtonState();
            
            setTimeout(() => { document.getElementById('entryTitle').focus(); }, 100);
        }

        function openEditEntryModal(entry) {
            isEditMode = true;
            editingEntry = entry;
            originalEntryData = { ...entry };
            document.getElementById('modalTitle').textContent = 'Edit Entry';
            
            const saveButton = document.getElementById('saveEntry');
            saveButton.disabled = true;
            saveButton.className = "flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed";
            
            document.getElementById('entryTitle').value = entry.title;
            document.getElementById('entryDescription').value = entry.description;
            document.getElementById('entryDate').value = entry.date;
            document.getElementById('alarmOptions').value = entry.alarmOptions || '1_day_before';
            document.getElementById('alarmDate').value = entry.alarmDate || '';
            
            const alarmDateInput = document.getElementById('alarmDate');
            if (entry.alarmTime && alarmDateInput) { alarmDateInput.dataset.customAlarmTime = entry.alarmTime; }
            
            document.getElementById('entryTime').value = entry.time;
            document.getElementById('entryPriority').value = entry.priority;
            document.getElementById('entryCategory').value = entry.category;
            
            // Set PIN to match entry's pinned status
            isPinModeActive = entry.pinned || false;
            updatePinModeDisplay();
            
            // Set LOCK to match entry's locked status
            isLockModeActive = entry.locked || false;
            updateLockModeDisplay();
            
            // Set CHECK to match entry's checked status
            isCheckModeActive = entry.checked || false;
            updateCheckModeDisplay();
            
            currentEntryMode = entry.mode;
            updateEntryModeDisplay();
            populateCardDropdown();
            document.getElementById('entryCard').value = entry.card;
            updateDateDisplay();
            updateAlarmOptionsDisplay(false);
            updateAlarmDisplay();
            
            updatePriorityStyling();
            updateCategoryStyling();
            
            updateSaveButtonState();
            addEntryModal.classList.remove('hidden');
        }

        function updateSaveButtonState() {
            const titleInput = document.getElementById('entryTitle');
            const saveButton = document.getElementById('saveEntry');
            const hasTitle = titleInput.value.trim().length > 0;
            let hasChanges = false;
            
            if (isEditMode && originalEntryData) {
                const alarmDateInput = document.getElementById('alarmDate');
                const currentCustomAlarmTime = alarmDateInput ? alarmDateInput.dataset.customAlarmTime : null;
                
                hasChanges = (
                    document.getElementById('entryTitle').value !== originalEntryData.title ||
                    document.getElementById('entryDescription').value !== originalEntryData.description ||
                    document.getElementById('entryDate').value !== originalEntryData.date ||
                    document.getElementById('alarmOptions').value !== (originalEntryData.alarmOptions || '1_day_before') ||
                    document.getElementById('alarmDate').value !== (originalEntryData.alarmDate || '') ||
                    (currentCustomAlarmTime || null) !== (originalEntryData.alarmTime || null) ||
                    document.getElementById('entryTime').value !== originalEntryData.time ||
                    document.getElementById('entryPriority').value !== originalEntryData.priority ||
                    document.getElementById('entryCategory').value !== originalEntryData.category ||
                    document.getElementById('entryCard').value !== originalEntryData.card ||
                    currentEntryMode !== originalEntryData.mode ||
                    isPinModeActive !== (originalEntryData.pinned || false) ||
                    isLockModeActive !== (originalEntryData.locked || false) ||
                    isCheckModeActive !== (originalEntryData.checked || false)
                );
            }
            
            const shouldEnable = hasTitle && (!isEditMode || hasChanges);
            saveButton.disabled = !shouldEnable;
            
            if (shouldEnable) {
                saveButton.className = "flex items-center justify-center w-10 h-10 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors";
            } else {
                saveButton.className = "flex items-center justify-center w-10 h-10 bg-gray-300 text-gray-500 rounded-md cursor-not-allowed";
            }
        }

        ['entryTitle', 'entryDescription', 'entryDate', 'alarmDate', 'entryTime', 'entryPriority', 'entryCategory', 'entryCard'].forEach(id => {
            const element = document.getElementById(id);
            const eventType = id.includes('Date') || id.includes('Time') || id.includes('Priority') || id.includes('Category') || id.includes('Card') ? 'change' : 'input';
            element.addEventListener(eventType, updateSaveButtonState);
            
            if (id === 'entryDate') { element.addEventListener('input', updateSaveButtonState); }
        });

        function updatePriorityStyling() {
            const prioritySelect = document.getElementById('entryPriority');
            const selectedValue = prioritySelect.value;
            
            prioritySelect.classList.remove('priority-1', 'priority-2', 'priority-3', 'priority-4');
            
            if (selectedValue) { prioritySelect.classList.add(`priority-${selectedValue}`); }
        }

        function updateCategoryStyling() {
            const categorySelect = document.getElementById('entryCategory');
            const selectedValue = categorySelect.value;
            
            categorySelect.classList.remove('category-personal', 'category-home', 'category-work', 'category-law', 'category-projects', 'category-unassigned');
            
            if (selectedValue) { categorySelect.classList.add(`category-${selectedValue}`); }
        }

        document.getElementById('entryPriority').addEventListener('change', () => {
            updatePriorityStyling();
            updateSaveButtonState();
        });

        document.getElementById('entryCategory').addEventListener('change', () => {
            updateCategoryStyling();
            updateSaveButtonState();
        });

        document.getElementById('pinModeBtn').addEventListener('click', () => {
            isPinModeActive = !isPinModeActive;
            updatePinModeDisplay();
            updateSaveButtonState();
        });

        document.getElementById('lockModeBtn').addEventListener('click', () => {
            isLockModeActive = !isLockModeActive;
            updateLockModeDisplay();
            updateSaveButtonState();
        });

        document.getElementById('checkModeBtn').addEventListener('click', () => {
            isCheckModeActive = !isCheckModeActive;
            updateCheckModeDisplay();
            updateSaveButtonState();
        });

        document.getElementById('taskModeBtn').addEventListener('click', () => {
            currentEntryMode = 'task';
            updateEntryModeDisplay();
            populateCardDropdown();
            updateSaveButtonState();
        });
        document.getElementById('eventModeBtn').addEventListener('click', () => {
            currentEntryMode = 'event';
            updateEntryModeDisplay();
            populateCardDropdown();
            updateSaveButtonState();
        });

        function updatePinModeDisplay() {
            const pinBtn = document.getElementById('pinModeBtn');
            if (isPinModeActive) {
                pinBtn.className = "px-2 py-1 rounded-lg transition-colors bg-red-100 text-red-600";
                pinBtn.title = "Pin Mode (On)";
            } else {
                pinBtn.className = "px-2 py-1 rounded-lg transition-colors text-gray-400 hover:text-gray-600 hover:bg-gray-100";
                pinBtn.title = "Pin Mode (Off)";
            }
        }

        function updateLockModeDisplay() {
            const lockBtn = document.getElementById('lockModeBtn');
            const deleteBtn = document.getElementById('deleteEntry');
            
            if (isLockModeActive) {
                lockBtn.className = "px-2 py-1 rounded-lg transition-colors bg-yellow-100 text-yellow-600";
                lockBtn.title = "Lock Mode (On)";
                
                // When LOCK is ON: Trash is OFF (disabled)
                deleteBtn.disabled = true;
                deleteBtn.className = "absolute left-0 flex items-center justify-center w-10 h-10 text-gray-400 rounded-md cursor-not-allowed";
                deleteBtn.title = "Delete (Lock required OFF)";
            } else {
                lockBtn.className = "px-2 py-1 rounded-lg transition-colors text-gray-400 hover:text-gray-600 hover:bg-gray-100";
                lockBtn.title = "Lock Mode (Off)";
                
                // When LOCK is OFF: Trash is ON (enabled if in edit mode)
                if (isEditMode && editingEntry) {
                    deleteBtn.disabled = false;
                    deleteBtn.className = "absolute left-0 flex items-center justify-center w-10 h-10 text-red-600 hover:bg-red-100 rounded-md transition-colors cursor-pointer";
                    deleteBtn.title = "Delete";
                } else {
                    // In ADD mode, keep TRASH disabled
                    deleteBtn.disabled = true;
                    deleteBtn.className = "absolute left-0 flex items-center justify-center w-10 h-10 text-gray-400 rounded-md cursor-not-allowed";
                    deleteBtn.title = "Delete (Cannot delete new entry)";
                }
            }
        }

        function updateCheckModeDisplay() {
            const checkBtn = document.getElementById('checkModeBtn');
            const titleInput = document.getElementById('entryTitle');
            
            if (isCheckModeActive) {
                checkBtn.className = "px-2 py-1 rounded-lg transition-colors bg-green-100 text-green-600";
                checkBtn.title = "Check Mode (On)";
                if (titleInput) {
                    titleInput.classList.add('entry-checked');
                }
            } else {
                checkBtn.className = "px-2 py-1 rounded-lg transition-colors text-gray-400 hover:text-gray-600 hover:bg-gray-100";
                checkBtn.title = "Check Mode (Off)";
                if (titleInput) {
                    titleInput.classList.remove('entry-checked');
                }
            }
        }

        function updateEntryModeDisplay() {
            const taskBtn = document.getElementById('taskModeBtn');
            const eventBtn = document.getElementById('eventModeBtn');
            if (currentEntryMode === 'task') {
                taskBtn.className = "px-2 py-1 rounded-lg transition-colors text-blue-600";
                eventBtn.className = "px-2 py-1 rounded-lg transition-colors text-gray-400 hover:text-gray-600 hover:bg-gray-100";
            } else {
                taskBtn.className = "px-2 py-1 rounded-lg transition-colors text-gray-400 hover:text-gray-600 hover:bg-gray-100";
                eventBtn.className = "px-2 py-1 rounded-lg transition-colors text-green-600";
            }
        }

        function getEntryPriorityColor(priority) {
            switch(priority) {
                case '1': return '#ef4444';
                case '2': return '#3b82f6';
                case '3': return '#fbbf24';
                case '4': return '#9ca3af';
                default: return '#9ca3af';
            }
        }

        function getEntryPriorityTextColor(priority) {
            switch(priority) {
                case '1': return 'white';
                case '2': return 'white';
                case '3': return 'black';
                case '4': return 'white';
                default: return 'white';
            }
        }

        function getCategoryColor(category) {
            switch(category) {
                case 'personal': return '#dbeafe';
                case 'home': return '#dcfce7';
                case 'work': return '#fef3c7';
                case 'law': return '#e9d5ff';
                case 'projects': return '#fce7f3';
                case 'unassigned': return '#ffffff';
                default: return '#f3f4f6';
            }
        }

        function getCategoryTextColor(category) {
            switch(category) {
                case 'personal': return '#1e40af';
                case 'home': return '#166534';
                case 'work': return '#92400e';
                case 'law': return '#7c2d12';
                case 'projects': return '#be185d';
                case 'unassigned': return '#4b5563';
                default: return '#374151';
            }
        }

        function createEntryElement(entry) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'calendar-entry text-xs mb-1 cursor-pointer rounded overflow-hidden';
            entryDiv.title = `${entry.title}\n${entry.description || ''}\n${formatDateShort(entry.date)}, ${formatTime12Hour(entry.time)}\n${entry.priority}: ${entry.category}`;
            // Check if entry is pinned - if so, disable dragging
            entryDiv.draggable = !entry.pinned;
            entryDiv.dataset.entryId = entry.id;
            
            if (isDateBeforeToday(entry.date)) { entryDiv.style.opacity = '0.5'; }
            
            const priorityBar = document.createElement('div');
            priorityBar.className = 'w-1 h-full absolute left-0 top-0';
            priorityBar.style.backgroundColor = getEntryPriorityColor(entry.priority);
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'block truncate text-xs font-medium pl-1.5 py-1';
            titleSpan.style.backgroundColor = getCategoryColor(entry.category);
            titleSpan.style.color = getCategoryTextColor(entry.category);
            titleSpan.textContent = entry.title;
            if (entry && entry.mode === 'event') { titleSpan.classList.add('event-title'); }

            
            // Add strikethrough if entry is checked
            if (entry.checked) {
                titleSpan.classList.add('entry-checked');
            }
            
            // Add pin icon if entry is pinned
            if (entry.pinned) {
                const pinIcon = document.createElement('div');
                pinIcon.className = 'absolute top-0 right-0 text-red-500';
                pinIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                `;
                entryDiv.appendChild(pinIcon);
            }

            // Add lock icon if entry is locked
            if (entry.locked) {
                const lockIcon = document.createElement('div');
                lockIcon.className = 'absolute top-0 right-0 text-yellow-600';
                lockIcon.style.right = entry.pinned ? '12px' : '0px'; // Offset if pin icon is present
                lockIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                `;
                entryDiv.appendChild(lockIcon);
            }

            // Add check icon if entry is checked
            if (entry.checked) {
                const checkIcon = document.createElement('div');
                checkIcon.className = 'absolute top-0 right-0 text-green-600';
                let rightOffset = '0px';
                if (entry.pinned && entry.locked) {
                    rightOffset = '24px';
                } else if (entry.pinned || entry.locked) {
                    rightOffset = '12px';
                }
                checkIcon.style.right = rightOffset;
                checkIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                `;
                entryDiv.appendChild(checkIcon);
            }
            
            entryDiv.style.position = 'relative';
            
            // Only add drag listeners if entry is not pinned
            if (!entry.pinned) {
                entryDiv.addEventListener('dragstart', (e) => {
                    e.stopPropagation();
                    entryDiv.style.opacity = '0.5';
                    entryDiv.style.transform = 'rotate(5deg)';
                    e.dataTransfer.setData('text/plain', entry.id);
                    e.dataTransfer.effectAllowed = 'move';
                    
                    entryDiv.classList.add('dragging');
                    document.body.classList.add('dragging-entry');
                });
            } else {
                // Add visual indicator that the entry cannot be dragged
                entryDiv.style.cursor = 'pointer';
            }
            
            entryDiv.addEventListener('dragend', (e) => {
                if (isDateBeforeToday(entry.date)) {
                    entryDiv.style.opacity = '0.5';
                } else {
                    entryDiv.style.opacity = '';
                }
                entryDiv.style.transform = '';
                entryDiv.classList.remove('dragging');
                document.body.classList.remove('dragging-entry');
            });
            
            entryDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!entryDiv.classList.contains('dragging')) { openEditEntryModal(entry); }
            });
            
            entryDiv.appendChild(priorityBar);
            entryDiv.appendChild(titleSpan);
            return entryDiv;
        }

        function getEntriesForDate(dateStr) {
            return calendarEntries.filter(entry => entry.date === dateStr);
        }

        function refreshCalendarDisplay() {
            generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            
            const scrollContainer = document.getElementById('scrollCalendarContainer');
            scrollContainer.innerHTML = '';
            generateScrollCalendar();
            
            updateAllCardEntries();
            
            if (isScrollView) {
                setTimeout(() => { scrollToCurrentMonth(); }, 100);
            }
        }

        function updateAllCardEntries() {
            updateCardEntries('T0', 'taskEntriesList');
            updateCardEntries('E0', 'eventEntriesList');
            
            const additionalCards = cards.filter(card => card.title !== 'T0' && card.title !== 'E0');
            additionalCards.forEach(card => {
                const containerId = `${card.title}EntriesList`;
                updateCardEntries(card.title, containerId);
            });
        }

        function updateCardEntries(cardTitle, containerId) {
            const entriesContainer = document.getElementById(containerId);
            if (!entriesContainer) { return; }
            
            // Calculate cutoff date (2 months ago from today)
            const today = new Date();
            const cutoffDate = new Date(today.getFullYear(), today.getMonth() - 2, 1);
            
            let cardEntries = [];
            
            if (cardTitle === 'T0') {
                cardEntries = calendarEntries.filter(entry => {
                    return entry.mode === 'task' && (entry.card === 'T0' || !entry.card || entry.card === '');
                });
            } 
            else if (cardTitle === 'E0') {
                cardEntries = calendarEntries.filter(entry => {
                    return entry.mode === 'event' && (entry.card === 'E0' || !entry.card || entry.card === '');
                });
            }
            else {
                cardEntries = calendarEntries.filter(entry => entry.card === cardTitle);
            }
            
            // Filter out entries older than 2 months
            cardEntries = cardEntries.filter(entry => {
                const entryDate = new Date(entry.date + 'T00:00:00');
                return entryDate >= cutoffDate;
            });
            
            cardEntries = cardEntries.filter((entry, index, self) => 
                index === self.findIndex(e => e.id === entry.id)
            );
            
            cardEntries.sort((a, b) => {
                const dateComparison = new Date(a.date) - new Date(b.date);
                if (dateComparison !== 0) return dateComparison;
                return parseInt(a.priority) - parseInt(b.priority);
            });
            
            entriesContainer.innerHTML = '';
            
            if (cardEntries.length === 0) {
                entriesContainer.innerHTML = `<div class="flex items-center justify-center h-full"><p class="text-gray-500 text-xs italic text-center">No ${cardTitle} entries yet</p></div>`;
                return;
            }
            
            cardEntries.forEach(entry => {
                const entryElement = createCardEntryElement(entry);
                entriesContainer.appendChild(entryElement);
            });
        }

        function updateTaskEntriesList() { updateCardEntries('T0', 'taskEntriesList'); }
        function createTaskEntryElement(entry) { return createCardEntryElement(entry); }
        function updateEventEntriesList() { updateCardEntries('E0', 'eventEntriesList'); }
        function createEventEntryElement(entry) { return createCardEntryElement(entry); }

        function createCardEntryElement(entry) {
            const entryDiv = document.createElement('div');
            
            let borderClass = 'border-gray-200';
            if (entry.mode === 'task') {
                borderClass = 'border-blue-200 hover:border-blue-300';
            } else if (entry.mode === 'event') {
                borderClass = 'border-green-200 hover:border-green-300';
            }
            
            entryDiv.className = `text-xs mb-0.5 cursor-pointer rounded overflow-hidden relative border ${borderClass} transition-colors`;
            entryDiv.title = `${entry.title}\n${entry.description || ''}\n${formatDateShort(entry.date)}, ${formatTime12Hour(entry.time)}\n${entry.priority}: ${entry.category}`;
            entryDiv.draggable = !entry.pinned;
            entryDiv.dataset.entryId = entry.id;
            
            if (isDateBeforeToday(entry.date)) { entryDiv.style.opacity = '0.5'; }
            
            const priorityBar = document.createElement('div');
            priorityBar.className = 'w-1 h-full absolute left-0 top-0';
            priorityBar.style.backgroundColor = getEntryPriorityColor(entry.priority);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex items-center justify-between pl-1.5 py-0.5';
            contentDiv.style.backgroundColor = getCategoryColor(entry.category);
            contentDiv.style.color = getCategoryTextColor(entry.category);
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'truncate text-xs font-medium flex-1 min-w-0';
            titleSpan.textContent = entry.title;
            if (entry && entry.mode === 'event') { titleSpan.classList.add('event-title'); }

            
            // Add strikethrough if entry is checked
            if (entry.checked) {
                titleSpan.classList.add('entry-checked');
            }
            
            const rightContent = document.createElement('div');
            rightContent.className = 'flex items-center space-x-1 flex-shrink-0 ml-2';
            
            // Add pin icon if entry is pinned
            if (entry.pinned) {
                const pinIcon = document.createElement('div');
                pinIcon.className = 'text-red-500 flex-shrink-0';
                pinIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                `;
                rightContent.appendChild(pinIcon);
            }

            // Add lock icon if entry is locked
            if (entry.locked) {
                const lockIcon = document.createElement('div');
                lockIcon.className = 'text-yellow-600 flex-shrink-0';
                lockIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                    </svg>
                `;
                rightContent.appendChild(lockIcon);
            }

            // Add check icon if entry is checked
            if (entry.checked) {
                const checkIcon = document.createElement('div');
                checkIcon.className = 'text-green-600 flex-shrink-0';
                checkIcon.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                `;
                rightContent.appendChild(checkIcon);
            }
            
            const dateTimeSpan = document.createElement('span');
            dateTimeSpan.className = 'text-xs flex-shrink-0';
            dateTimeSpan.textContent = `${formatDateShort(entry.date)}, ${formatTime12Hour(entry.time)}`;
            rightContent.appendChild(dateTimeSpan);
            
            contentDiv.appendChild(titleSpan);
            contentDiv.appendChild(rightContent);
            
            entryDiv.addEventListener('dragstart', (e) => {
                e.stopPropagation();
                entryDiv.classList.add('dragging-card-entry');
                e.dataTransfer.setData('text/plain', entry.id);
                e.dataTransfer.effectAllowed = 'move';
            });
            
            entryDiv.addEventListener('dragend', (e) => {
                entryDiv.classList.remove('dragging-card-entry');
                document.querySelectorAll('.note-item').forEach(card => {
                    card.classList.remove('card-drop-zone-active', 'card-drop-zone-hover');
                });
            });
            
            entryDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                if (!entryDiv.classList.contains('dragging-card-entry')) { openEditEntryModal(entry); }
            });
            
            entryDiv.appendChild(priorityBar);
            entryDiv.appendChild(contentDiv);
            
            return entryDiv;
        }

        function formatDateShort(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const day = date.getDate();
            const month = monthNames[date.getMonth()];
            return `${day} ${month}`;
        }

        function addTaskToUI(title, description, dueDate) {
            const todoTasks = document.getElementById('todoTasks');
            const taskElement = document.createElement('div');
            taskElement.className = 'task-item bg-white p-3 rounded-md shadow-sm border border-gray-200';
            taskElement.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex items-start space-x-2">
                        <input type="checkbox" class="mt-1 rounded border-gray-300">
                        <div>
                            <div class="text-sm font-medium">${title}</div>
                            ${description ? `<div class="text-xs text-gray-500 mt-1">${description}</div>` : ''}
                        </div>
                    </div>
                    <span class="text-xs text-gray-500">${dueDate || 'No due date'}</span>
                </div>
            `;
            todoTasks.appendChild(taskElement);
        }

        function addNoteToUI(title, content) {
            const notesView = document.getElementById('notesView').querySelector('.grid');
            const noteElement = document.createElement('div');
            noteElement.className = 'note-item bg-purple-50 p-4 rounded-lg border border-purple-200';
            noteElement.innerHTML = `
                <h3 class="font-semibold mb-2">${title}</h3>
                <p class="text-sm text-gray-600">${content.length > 100 ? content.substring(0, 100) + '...' : content}</p>
                <span class="text-xs text-gray-500 mt-2 block">Just now</span>
            `;
            notesView.appendChild(noteElement);
        }

        calendarIcon.addEventListener('click', () => {
            showView('calendar');
            updateIconHighlight('calendar');
            
            const today = new Date();
            currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
            
            if (isScrollView) {
                setTimeout(() => { scrollToCurrentMonth(); }, 100);
            } else {
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            }
        });
        ideasIcon.addEventListener('click', () => {
            showView('notes');
            updateIconHighlight('ideas');
        });

        document.getElementById('notesView').addEventListener('click', (e) => {
            const notesView = document.getElementById('notesView');
            if (!notesView.classList.contains('hidden')) {
                const cardsContainer = document.getElementById('cardsContainer');
                if (e.target === notesView || e.target === cardsContainer || 
                    (e.target.classList && e.target.classList.contains('mb-6')) ||
                    (e.target.classList && e.target.classList.contains('grid'))) {
                    selectedCardType = 'task';
                    document.getElementById('cardTitle').value = '';
                    forceTaskSelection();
                    document.getElementById('addCardModal').classList.remove('hidden');
                    setTimeout(() => { forceTaskSelection(); }, 50);
                }
            }
        });

        function showView(viewName) {
            viewSections.forEach(section => section.classList.add('hidden'));
            const monthNavigation = document.getElementById('monthNavigation');
            switch(viewName) {
                case 'calendar':
                    document.getElementById('calendarView').classList.remove('hidden');
                    viewToggle.classList.remove('hidden');
                    monthNavigation.classList.remove('hidden');
                    break;
                case 'notes':
                    document.getElementById('notesView').classList.remove('hidden');
                    viewToggle.classList.add('hidden');
                    monthNavigation.classList.add('hidden');
                    break;
            }
        }

        function updateIconHighlight(activeIcon) {
            calendarIcon.className = "p-1.5 text-gray-600 hover:text-sky-600 transition-colors";
            ideasIcon.className = "p-1.5 text-gray-600 hover:text-primary transition-colors";
            if (activeIcon === 'calendar') {
                calendarIcon.className = "p-1.5 text-sky-500 bg-sky-100 rounded-lg hover:text-sky-600 transition-colors";
            } else if (activeIcon === 'ideas') {
                ideasIcon.className = "p-1.5 text-primary bg-primary/10 rounded-lg hover:text-primary transition-colors";
            }
        }

        function generateCalendar(year, month) {
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            const mondayOffset = startDay === 0 ? 6 : startDay - 1;
            const calendarGrid = document.getElementById('calendarGrid');
            const currentMonthElement = document.getElementById('currentMonth');
            currentMonthElement.textContent = `${monthNames[month]} ${year}`;
            calendarGrid.innerHTML = '';
            for (let i = 0; i < mondayOffset; i++) {
                const cell = document.createElement('div');
                cell.className = 'h-32 border-r border-b border-gray-200 bg-gray-50';
                calendarGrid.appendChild(cell);
            }
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                const isLastColumn = (mondayOffset + day - 1) % 7 === 6;
                cell.className = `h-40 border-b border-gray-200 bg-white hover:bg-gray-50 transition-colors cursor-pointer relative p-2 ${
                    isLastColumn ? '' : 'border-r'
                }`;
                const dateNumber = document.createElement('div');
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                let textColor = 'text-gray-900';
                
                if (year < currentYear || (year === currentYear && month < currentMonth)) {
                    textColor = 'text-gray-300';
                } else if (year > currentYear || (year === currentYear && month > currentMonth)) {
                    textColor = 'text-gray-500';
                }
                
                dateNumber.className = `absolute top-2 right-2 text-sm font-medium ${
                    isToday 
                        ? 'bg-sky-500 text-white w-5 h-5 rounded flex items-center justify-center' 
                        : textColor
                }`;
                dateNumber.textContent = day;
                const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                cell.setAttribute("data-date", dateStr);
                
                cell.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (e.target === dateNumber) return;
                    if (!isLongPress) { openEntryModalWithDate(dateStr); }
                });
                
                addLongPressListeners(cell, dateStr);
                addLongPressListeners(dateNumber, dateStr);
                addDropZoneListeners(cell, dateStr);
                
                cell.appendChild(dateNumber);
                const entriesForDate = getEntriesForDate(dateStr);
                const entriesContainer = document.createElement('div');
                entriesContainer.className = 'mt-6 space-y-1 overflow-hidden';
                entriesContainer.style.maxHeight = '120px';
                
                entriesForDate.forEach(entry => {
                    entriesContainer.appendChild(createEntryElement(entry));
                });
                cell.appendChild(entriesContainer);
                
                setTimeout(() => {
                    const hasOverflow = entriesContainer.scrollHeight > entriesContainer.clientHeight;
                    if (hasOverflow && entriesForDate.length > 0) {
                        const ellipsis = document.createElement('div');
                        ellipsis.className = 'absolute bottom-1 right-1 text-xs text-gray-400 font-bold bg-white px-1 rounded';
                        ellipsis.textContent = '...';
                        ellipsis.title = `${entriesForDate.length} entries total`;
                        ellipsis.style.zIndex = '10';
                        cell.appendChild(ellipsis);
                    }
                }, 10);
                calendarGrid.appendChild(cell);
            }
            const totalCells = calendarGrid.children.length;
            const remainingCells = 42 - totalCells;
            if (remainingCells > 0 && remainingCells < 7) {
                for (let i = 0; i < remainingCells; i++) {
                    const cell = document.createElement('div');
                    const isLastColumn = (totalCells + i) % 7 === 6;
                    cell.className = `h-40 border-b border-gray-200 bg-gray-50 ${
                        isLastColumn ? '' : 'border-r'
                    }`;
                    calendarGrid.appendChild(cell);
                }
            }
        
            applyDayAlertEffects();
}

        document.getElementById('prevMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            if (isScrollView) {
                updateCurrentMonthLabel();
                setTimeout(() => { scrollToSpecificMonth(currentDate.getFullYear(), currentDate.getMonth()); }, 100);
            } else {
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            }
        });
        document.getElementById('nextMonth').addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            if (isScrollView) {
                updateCurrentMonthLabel();
                setTimeout(() => { scrollToSpecificMonth(currentDate.getFullYear(), currentDate.getMonth()); }, 100);
            } else {
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            }
        });

        document.getElementById('currentMonth').addEventListener('click', () => {
            const today = new Date();
            currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
            
            if (isScrollView) {
                updateCurrentMonthLabel();
                setTimeout(() => { scrollToCurrentMonth(); }, 100);
            } else {
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            }
        });

        function updateToggleIcon() {
            if (isScrollView) {
                viewToggle.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 9l4-4 4 4m0 6l-4 4-4-4" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14" />
                    </svg>
                `;
                viewToggle.title = "Scroll View - Switch to Month View";
            } else {
                viewToggle.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                `;
                viewToggle.title = "Month View - Switch to Scroll View";
            }
        }

        viewToggle.addEventListener('click', () => {
            isScrollView = !isScrollView;
            if (isScrollView) {
                scrollView.classList.remove('hidden');
                monthView.classList.add('hidden');
                // regenerate scroll calendar and ensure entries show
                generateScrollCalendar();
                updateAllCardEntries();
                setTimeout(() => { scrollToCurrentMonth(); }, 100);
            } else {
                scrollView.classList.add('hidden');
                monthView.classList.remove('hidden');
                
                const today = new Date();
                currentDate = new Date(today.getFullYear(), today.getMonth(), 1);
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            }
            updateToggleIcon();
        });

        function generateScrollCalendar() {
            const scrollContainer = document.getElementById('scrollCalendarContainer'); const today = new Date();
            const startDate = new Date(2024, 11, 1); // start at December 2024 (fixed)

            const calendarGrid = document.createElement('div');
            calendarGrid.className = 'grid grid-cols-7';
            
            for (let i = 0; i < 60; i++) {
                const currentMonth = new Date(startDate.getFullYear(), startDate.getMonth() + i, 1);
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const daysInMonth = lastDay.getDate();
                const startDay = firstDay.getDay();
                const mondayOffset = startDay === 0 ? 6 : startDay - 1;
                
                if (i === 0) {
                    for (let j = 0; j < mondayOffset; j++) {
                        const emptyCell = document.createElement('div');
                        emptyCell.className = 'h-32 border-r border-b border-gray-200 bg-gray-50';
                        calendarGrid.appendChild(emptyCell);
                    }
                }
                
                for (let day = 1; day <= daysInMonth; day++) {
                    const cell = document.createElement('div');
                    cell.dataset.month = month;
                    cell.dataset.year = year;
                    const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                    const totalCellsSoFar = calendarGrid.children.length;
                    const isLastColumn = (totalCellsSoFar) % 7 === 6;
                    cell.className = `h-40 border-b border-gray-200 bg-white hover:bg-gray-50 transition-colors cursor-pointer relative p-2 ${
                        isLastColumn ? '' : 'border-r'
                    }`;
                    const dateNumber = document.createElement('div');
                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();
                    let textColor = 'text-gray-900';
                    
                    if (year < currentYear || (year === currentYear && month < currentMonth)) {
                        textColor = 'text-gray-300';
                    } else if (year > currentYear || (year === currentYear && month > currentMonth)) {
                        textColor = 'text-gray-500';
                    }
                    
                    dateNumber.className = `absolute top-2 right-2 text-sm font-medium ${
                        isToday 
                            ? 'bg-sky-500 text-white w-5 h-5 rounded flex items-center justify-center' 
                            : textColor
                    }`;
                    if (day === 1) {
                        dateNumber.textContent = `${monthNames[month]} ${day}`;
                    } else {
                        dateNumber.textContent = day;
                    }
                    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                cell.setAttribute("data-date", dateStr);
                    
                    cell.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (e.target === dateNumber) return;
                        if (!isLongPress) { openEntryModalWithDate(dateStr); }
                    });
                    
                    addLongPressListeners(cell, dateStr);
                    addLongPressListeners(dateNumber, dateStr);
                    addDropZoneListeners(cell, dateStr);
                    
                    cell.appendChild(dateNumber);
                    const entriesForDate = getEntriesForDate(dateStr);
                    const entriesContainer = document.createElement('div');
                    entriesContainer.className = 'mt-6 space-y-1 overflow-hidden';
                    entriesContainer.style.maxHeight = '120px';
                    
                    entriesForDate.forEach(entry => {
                        entriesContainer.appendChild(createEntryElement(entry));
                    });
                    cell.appendChild(entriesContainer);
                    
                    setTimeout(() => {
                        const hasOverflow = entriesContainer.scrollHeight > entriesContainer.clientHeight;
                        if (hasOverflow && entriesForDate.length > 0) {
                            const ellipsis = document.createElement('div');
                            ellipsis.className = 'absolute bottom-1 right-1 text-xs text-gray-400 font-bold bg-white px-1 rounded';
                            ellipsis.textContent = '...';
                            ellipsis.title = `${entriesForDate.length} entries total`;
                            ellipsis.style.zIndex = '10';
                            cell.appendChild(ellipsis);
                        }
                    }, 10);
                    calendarGrid.appendChild(cell);
                }
            }
            
            const totalCells = calendarGrid.children.length;
            const remainingCells = totalCells % 7;
            if (remainingCells > 0) {
                for (let j = remainingCells; j < 7; j++) {
                    const emptyCell = document.createElement('div');
                    const isLastColumn = j === 6;
                    emptyCell.className = `h-32 border-b border-gray-200 bg-gray-50 ${
                        isLastColumn ? '' : 'border-r'
                    }`;
                    calendarGrid.appendChild(emptyCell);
                }
            }
            
            scrollContainer.appendChild(calendarGrid);
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            if (currentYear >= 2024 && (currentYear > 2024 || currentMonth >= 11)) {
                setTimeout(() => {
                    const cells = calendarGrid.children;
                    for (let i = 0; i < cells.length; i++) {
                        const cell = cells[i];
                        if (cell.querySelector('.bg-sky-500')) {
                            cell.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            break;
                        }
                    }
                }, 100);
            }
        
            applyDayAlertEffects();
}

        function updateDateDisplay() {
            const dateInput = document.getElementById('entryDate');
            const dateDisplayText = document.querySelector('#dateDisplay span');
            if (dateInput.value) {
                const date = new Date(dateInput.value + 'T00:00:00');
                const day = date.getDate();
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                const dayOfWeek = dayNames[date.getDay()];
                dateDisplayText.textContent = `${day} ${month} ${year} [${dayOfWeek}]`;
            } else {
                dateDisplayText.textContent = 'Select Date';
            }
        }

        function populateTimeOptions() {
            const timeSelect = document.getElementById('entryTime');
            timeSelect.innerHTML = '';
            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    const time24 = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    let hour12 = hour;
                    let ampm = 'am';
                    if (hour === 0) {
                        hour12 = 12;
                    } else if (hour === 12) {
                        ampm = 'pm';
                    } else if (hour > 12) {
                        hour12 = hour - 12;
                        ampm = 'pm';
                    }
                    const time12 = `${hour12.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')} ${ampm}`;
                    const option = document.createElement('option');
                    option.value = time24;
                    option.textContent = time12;
                    timeSelect.appendChild(option);
                }
            }
            timeSelect.value = '08:00';
        }

        function openEntryModalWithDate(dateStr) {
            isEditMode = false;
            editingEntry = null;
            originalEntryData = null;
            document.getElementById('modalTitle').textContent = 'Add Entry';
            
            selectedDate = dateStr;
            document.getElementById('entryDate').value = dateStr;
            document.getElementById('alarmOptions').value = '1_day_before';
            updateAlarmOptionsDisplay();
            updateDateDisplay();
            document.getElementById('entryTime').value = '08:00';
            
            // STRICTLY ENFORCE: PIN function = default OFF for ADD ENTRY
            isPinModeActive = false;
            updatePinModeDisplay();
            
            // STRICTLY ENFORCE: LOCK function = default OFF for ADD ENTRY
            isLockModeActive = false;
            updateLockModeDisplay();
            
            // STRICTLY ENFORCE: CHECK function = default OFF for ADD ENTRY
            isCheckModeActive = false;
            updateCheckModeDisplay();
            
            currentEntryMode = 'task';
            updateEntryModeDisplay();
            updateAlarmDisplay();
            populateCardDropdown();
            
            document.getElementById('entryPriority').value = '4';
            document.getElementById('entryCategory').value = 'work';
            updatePriorityStyling();
            updateCategoryStyling();
            
            updateSaveButtonState();
            addEntryModal.classList.remove('hidden');
            
            setTimeout(() => { document.getElementById('entryTitle').focus(); }, 100);
        }

        function initializeDefaultDates() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('entryDate').value = today;
            document.getElementById('alarmOptions').value = '1_day_before';
            updateAlarmOptionsDisplay();
            updateDateDisplay();
            updateAlarmDisplay();
        }

        function openCustomDatePicker() {
            const customPicker = document.getElementById('customDatePicker');
            const currentValue = document.getElementById('entryDate').value;
            if (currentValue) {
                pickerCurrentDate = new Date(currentValue + 'T00:00:00');
            } else {
                pickerCurrentDate = new Date();
            }
            generatePickerCalendar();
            customPicker.classList.remove('hidden');
        }

        function generatePickerCalendar() {
            const year = pickerCurrentDate.getFullYear();
            const month = pickerCurrentDate.getMonth();
            const pickerGrid = document.getElementById('pickerCalendarGrid');
            const pickerMonthElement = document.getElementById('pickerMonth');
            pickerMonthElement.textContent = `${monthNames[month]} ${year}`;
            pickerGrid.innerHTML = '';
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            const mondayOffset = startDay === 0 ? 6 : startDay - 1;
            for (let i = 0; i < mondayOffset; i++) {
                const cell = document.createElement('div');
                cell.className = 'h-8 w-8';
                pickerGrid.appendChild(cell);
            }
            const today = new Date();
            const selectedValue = document.getElementById('entryDate').value;
            let selectedDate = null;
            if (selectedValue) { selectedDate = new Date(selectedValue + 'T00:00:00'); }
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                const cellDate = new Date(year, month, day);
                const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                const isSelected = selectedDate && year === selectedDate.getFullYear() && month === selectedDate.getMonth() && day === selectedDate.getDate();
                cell.className = `h-8 w-8 flex items-center justify-center text-sm cursor-pointer rounded transition-colors ${
                    isSelected 
                        ? 'bg-primary text-white font-semibold' 
                        : isToday 
                            ? 'bg-sky-100 text-sky-700 font-semibold hover:bg-sky-200'
                            : 'hover:bg-gray-100 text-gray-700'
                }`;
                cell.textContent = day;
                cell.addEventListener('click', () => {
                    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                cell.setAttribute("data-date", dateStr);
                    document.getElementById('entryDate').value = dateStr;
                    updateDateDisplay();
                    const alarmOptions = document.getElementById('alarmOptions');
                    if (alarmOptions.value !== 'custom') {
                        const calculatedDate = calculateAlarmDate(dateStr, alarmOptions.value);
                        document.getElementById('alarmDate').value = calculatedDate;
                        const alarmDateInput = document.getElementById('alarmDate');
                        if (alarmDateInput) { delete alarmDateInput.dataset.customAlarmTime; }
                        updateAlarmDateDisplay();
                    }
                    updateAlarmDisplay();
                    updateSaveButtonState();
                    document.getElementById('customDatePicker').classList.add('hidden');
                });
                pickerGrid.appendChild(cell);
            }
        }

        document.getElementById('prevPickerMonth').addEventListener('click', (e) => {
            e.stopPropagation();
            pickerCurrentDate.setMonth(pickerCurrentDate.getMonth() - 1);
            generatePickerCalendar();
        });
        document.getElementById('nextPickerMonth').addEventListener('click', (e) => {
            e.stopPropagation();
            pickerCurrentDate.setMonth(pickerCurrentDate.getMonth() + 1);
            generatePickerCalendar();
        });

        function updateAlarmDateDisplay() {
            const alarmDateInput = document.getElementById('alarmDate');
            const alarmDateDisplayText = document.querySelector('#alarmDateDisplay span');
            if (alarmDateInput && alarmDateInput.value) {
                const date = new Date(alarmDateInput.value + 'T00:00:00');
                const day = date.getDate();
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                const dayOfWeek = dayNames[date.getDay()];
                if (alarmDateDisplayText) {
                    alarmDateDisplayText.textContent = `${day} ${month} ${year} [${dayOfWeek}]`;
                }
            } else if (alarmDateDisplayText) {
                alarmDateDisplayText.textContent = 'Custom Alarm Date';
            }
        }

        function openAlarmDatePicker() {
            const alarmCustomPicker = document.getElementById('alarmCustomDatePicker');
            const currentValue = document.getElementById('alarmDate').value;
            if (currentValue) {
                alarmPickerCurrentDate = new Date(currentValue + 'T00:00:00');
            } else {
                alarmPickerCurrentDate = new Date();
            }
            generateAlarmPickerCalendar();
            alarmCustomPicker.classList.remove('hidden');
        }

        function generateAlarmPickerCalendar() {
            const year = alarmPickerCurrentDate.getFullYear();
            const month = alarmPickerCurrentDate.getMonth();
            const alarmPickerGrid = document.getElementById('alarmPickerCalendarGrid');
            const alarmPickerMonthElement = document.getElementById('alarmPickerMonth');
            alarmPickerMonthElement.textContent = `${monthNames[month]} ${year}`;
            alarmPickerGrid.innerHTML = '';
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            const mondayOffset = startDay === 0 ? 6 : startDay - 1;
            for (let i = 0; i < mondayOffset; i++) {
                const cell = document.createElement('div');
                cell.className = 'h-8 w-8';
                alarmPickerGrid.appendChild(cell);
            }
            const today = new Date();
            const selectedValue = document.getElementById('alarmDate').value;
            let selectedDate = null;
            if (selectedValue) { selectedDate = new Date(selectedValue + 'T00:00:00'); }
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                const cellDate = new Date(year, month, day);
                const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                const isSelected = selectedDate && year === selectedDate.getFullYear() && month === selectedDate.getMonth() && day === selectedDate.getDate();
                cell.className = `h-8 w-8 flex items-center justify-center text-sm cursor-pointer rounded transition-colors ${
                    isSelected 
                        ? 'bg-orange-500 text-white font-semibold' 
                        : isToday 
                            ? 'bg-orange-100 text-orange-700 font-semibold hover:bg-orange-200'
                            : 'hover:bg-gray-100 text-gray-700'
                }`;
                cell.textContent = day;
                cell.addEventListener('click', () => {
                    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                cell.setAttribute("data-date", dateStr);
                    document.getElementById('alarmDate').value = dateStr;
                    updateAlarmDateDisplay();
                    updateAlarmDisplay();
                    document.getElementById('alarmCustomDatePicker').classList.add('hidden');
                });
                alarmPickerGrid.appendChild(cell);
            }
        }

        document.getElementById('prevAlarmPickerMonth').addEventListener('click', (e) => {
            e.stopPropagation();
            alarmPickerCurrentDate.setMonth(alarmPickerCurrentDate.getMonth() - 1);
            generateAlarmPickerCalendar();
        });
        document.getElementById('nextAlarmPickerMonth').addEventListener('click', (e) => {
            e.stopPropagation();
            alarmPickerCurrentDate.setMonth(alarmPickerCurrentDate.getMonth() + 1);
            generateAlarmPickerCalendar();
        });

        document.addEventListener('click', (e) => {
            const customPicker = document.getElementById('customDatePicker');
            const alarmCustomPicker = document.getElementById('alarmCustomDatePicker');
            const datePickerContainer = document.querySelector('#dateDisplay').closest('.relative');
            const alarmPickerContainer = document.querySelector('#alarmDateDisplay')?.closest('.relative');
            const isClickInsideDatePickerArea = datePickerContainer.contains(e.target) || customPicker.contains(e.target);
            const isClickInsideAlarmPickerArea = alarmPickerContainer && (alarmPickerContainer.contains(e.target) || alarmCustomPicker.contains(e.target));
            if (!isClickInsideDatePickerArea && !customPicker.classList.contains('hidden')) {
                customPicker.classList.add('hidden');
            }
            if (!isClickInsideAlarmPickerArea && !alarmCustomPicker.classList.contains('hidden')) {
                alarmCustomPicker.classList.add('hidden');
            }
        });

        document.getElementById('dateDisplay').addEventListener('click', (e) => {
            e.stopPropagation();
            const customPicker = document.getElementById('customDatePicker');
            const alarmCustomPicker = document.getElementById('alarmCustomDatePicker');
            alarmCustomPicker.classList.add('hidden');
            if (customPicker.classList.contains('hidden')) {
                openCustomDatePicker();
            } else {
                customPicker.classList.add('hidden');
            }
        });
        document.getElementById('entryDate').addEventListener('click', (e) => {
            e.stopPropagation();
            const customPicker = document.getElementById('customDatePicker');
            const alarmCustomPicker = document.getElementById('alarmCustomDatePicker');
            alarmCustomPicker.classList.add('hidden');
            if (customPicker.classList.contains('hidden')) {
                openCustomDatePicker();
            } else {
                customPicker.classList.add('hidden');
            }
        });
        
        const alarmDateDisplay = document.getElementById('alarmDateDisplay');
        const alarmDateInput = document.getElementById('alarmDate');
        if (alarmDateDisplay) {
            alarmDateDisplay.addEventListener('click', (e) => {
                e.stopPropagation();
                const alarmCustomPicker = document.getElementById('alarmCustomDatePicker');
                const customPicker = document.getElementById('customDatePicker');
                customPicker.classList.add('hidden');
                if (alarmCustomPicker.classList.contains('hidden')) {
                    openAlarmDatePicker();
                } else {
                    alarmCustomPicker.classList.add('hidden');
                }
            });
        }
        if (alarmDateInput) {
            alarmDateInput.addEventListener('click', (e) => {
                e.stopPropagation();
                const alarmCustomPicker = document.getElementById('alarmCustomDatePicker');
                const customPicker = document.getElementById('customDatePicker');
                customPicker.classList.add('hidden');
                if (alarmCustomPicker.classList.contains('hidden')) {
                    openAlarmDatePicker();
                } else {
                    alarmCustomPicker.classList.add('hidden');
                }
            });
            alarmDateInput.addEventListener('change', () => {
                updateAlarmDateDisplay();
                updateAlarmDisplay();
            });
        }

        function populateWelcomeModal() {
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${(today.getMonth() + 1).toString().padStart(2, '0')}-${today.getDate().toString().padStart(2, '0')}`;
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();
            
            const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            const dayOfWeek = dayNames[today.getDay()];
            const day = today.getDate();
            const month = monthNames[today.getMonth()];
            
            document.getElementById('todaySection').textContent = `Today [${day} ${month}]`;
            
            const todayEntries = calendarEntries.filter(entry => entry.date === todayStr);
            
            todayEntries.sort((a, b) => {
                const dateComparison = a.date.localeCompare(b.date);
                if (dateComparison !== 0) return dateComparison;
                return a.title.localeCompare(b.title);
            });
            
            const todayContainer = document.getElementById('todayEntries');
            todayContainer.innerHTML = '';
            
            if (todayEntries.length === 0) {
                todayContainer.innerHTML = '<p class="text-gray-500 text-sm italic">No entries for today</p>';
            } else {
                todayEntries.forEach(entry => {
                    const entryEl = createWelcomeEntryElement(entry);
                    todayContainer.appendChild(entryEl);
                });
            }
            
            document.getElementById('monthSection').textContent = `${month} ${currentYear}`;
            
            const startOfMonth = new Date(currentYear, currentMonth, 1);
            const endOfMonth = new Date(currentYear, currentMonth + 1, 0);
            
            const monthEntries = calendarEntries.filter(entry => {
                const entryDate = new Date(entry.date + 'T00:00:00');
                return entryDate >= startOfMonth && entryDate <= endOfMonth && 
                       entry.date !== todayStr &&
                       (entry.priority === '1' || entry.priority === '2');
            });
            
            monthEntries.sort((a, b) => {
                const dateComparison = a.date.localeCompare(b.date);
                if (dateComparison !== 0) return dateComparison;
                return a.title.localeCompare(b.title);
            });
            
            const monthContainer = document.getElementById('monthEntries');
            monthContainer.innerHTML = '';
            
            if (monthEntries.length === 0) {
                monthContainer.innerHTML = '<p class="text-gray-500 text-sm italic">No priority 1-2 entries this month</p>';
            } else {
                monthEntries.forEach(entry => {
                    const entryEl = createWelcomeEntryElement(entry);
                    monthContainer.appendChild(entryEl);
                });
            }
            
            updateImportantSection();
        }

        function updateImportantSection() {
            const importantContainer = document.getElementById('importantEntries');
            const importantCards = cards.filter(card => card.important === true);
            
            importantContainer.innerHTML = '';
            
            if (importantCards.length === 0) {
                importantContainer.innerHTML = '<p class="text-gray-500 text-sm italic">No flagged entries yet</p>';
            } else {
                importantCards.forEach(card => {
                    const cardEl = createImportantCardElement(card);
                    importantContainer.appendChild(cardEl);
                });
            }
        }

        function createImportantCardElement(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'text-xs mb-1 cursor-pointer rounded overflow-hidden relative';
            
            const priorityBar = document.createElement('div');
            priorityBar.className = 'w-1 h-full absolute left-0 top-0';
            priorityBar.style.backgroundColor = '#ef4444';
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'block text-xs font-medium text-gray-700 pl-1.5';
            
            let displayText = card.title;
            if (card.content && card.content.trim()) {
                const notes = card.content.trim();
                const truncatedNotes = notes.length > 50 ? notes.substring(0, 50) + '...' : notes;
                displayText = `${card.title}: ${truncatedNotes}`;
            } else {
                displayText = `${card.title}: (no notes)`;
            }
            
            titleSpan.textContent = displayText;
            
            cardDiv.appendChild(priorityBar);
            cardDiv.appendChild(titleSpan);
            
            return cardDiv;
        }
        
        function createWelcomeEntryElement(entry) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'text-xs mb-1 cursor-pointer rounded overflow-hidden relative';
            entryDiv.title = `${entry.title}\n${entry.description || ''}\n${formatDateShort(entry.date)}, ${formatTime12Hour(entry.time)}\n${entry.priority}: ${entry.category}`;
            
            if (isDateBeforeToday(entry.date)) { entryDiv.style.opacity = '0.5'; }
            
            const priorityBar = document.createElement('div');
            priorityBar.className = 'w-1 h-full absolute left-0 top-0';
            priorityBar.style.backgroundColor = getEntryPriorityColor(entry.priority);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex items-center justify-between pl-1.5 py-1';
            contentDiv.style.backgroundColor = getCategoryColor(entry.category);
            contentDiv.style.color = getCategoryTextColor(entry.category);
            
            const leftContent = document.createElement('div');
            leftContent.className = 'flex-1 min-w-0';
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'block truncate text-xs font-medium';
            titleSpan.textContent = entry.title;
            if (entry && entry.mode === 'event') { titleSpan.classList.add('event-title'); }

            
            // Add strikethrough if entry is checked
            if (entry.checked) {
                titleSpan.classList.add('entry-checked');
            }
            
            leftContent.appendChild(titleSpan);
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-xs flex-shrink-0 ml-2';
            
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            const isToday = entry.date === todayStr;
            
            if (isToday) {
                timeSpan.textContent = formatTime12Hour(entry.time);
            } else {
                const entryDate = new Date(entry.date + 'T00:00:00');
                const day = entryDate.getDate();
                const month = monthNames[entryDate.getMonth()];
                timeSpan.textContent = `${day} ${month}, ${formatTime12Hour(entry.time)}`;
            }
            
            contentDiv.appendChild(leftContent);
            contentDiv.appendChild(timeSpan);
            
            entryDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                openEditEntryModal(entry);
                document.getElementById('welcomeModal').classList.add('hidden');
            });
            
            entryDiv.appendChild(priorityBar);
            entryDiv.appendChild(contentDiv);
            
            return entryDiv;
        }
        
        document.getElementById('closeWelcome').addEventListener('click', () => {
            document.getElementById('welcomeModal').classList.add('hidden');
        });
        
        document.getElementById('welcomeModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('welcomeModal')) {
                document.getElementById('welcomeModal').classList.add('hidden');
            }
        });

        
function openDayModal(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const day = date.getDate();
            const month = fullMonthNames[date.getMonth()];
            const year = date.getFullYear();
            
            // Initialize alert state and SAVE button strictly on modal open
            // Always disable SAVE on modal open, then sync visual state
            initialAlertState = (dayAlerts && dayAlerts[dateStr] !== undefined) ? dayAlerts[dateStr] : 0;
            alertState = initialAlertState;
            if (closeDayModalBtn) {
                closeDayModalBtn.disabled = true;
                closeDayModalBtn.classList.add("opacity-50", "cursor-not-allowed");
            }
            updateAlertIcon();
            
            document.getElementById('dayModalTitle').textContent = `${day} ${month} ${year}`;
            
            const entriesForDate = getEntriesForDate(dateStr);
            const dayModalEntriesContainer = document.getElementById('dayModalEntries');
            dayModalEntriesContainer.innerHTML = '';
            
            if (entriesForDate.length === 0) {
                dayModalEntriesContainer.innerHTML = '<p class="text-gray-500 text-sm italic">No entries for this day</p>';
            } else {
                entriesForDate.forEach(entry => {
                    const entryEl = createDayModalEntryElement(entry);
                    dayModalEntriesContainer.appendChild(entryEl);
                });
            }
            
            document.getElementById('dayModal').classList.remove('hidden');
        }

        
        function createDayModalEntryElement(entry) {
            const entryDiv = document.createElement('div');
            entryDiv.className = 'text-xs mb-1 cursor-pointer rounded overflow-hidden relative';
            entryDiv.title = `${entry.title}\n${entry.description || ''}\n${formatDateShort(entry.date)}, ${formatTime12Hour(entry.time)}\n${entry.priority}: ${entry.category}`;
            
            if (isDateBeforeToday(entry.date)) { entryDiv.style.opacity = '0.5'; }
            
            const priorityBar = document.createElement('div');
            priorityBar.className = 'w-1 h-full absolute left-0 top-0';
            priorityBar.style.backgroundColor = getEntryPriorityColor(entry.priority);
            
            const contentDiv = document.createElement('div');
            contentDiv.className = 'flex items-center justify-between pl-1.5 py-1';
            contentDiv.style.backgroundColor = getCategoryColor(entry.category);
            contentDiv.style.color = getCategoryTextColor(entry.category);
            
            const leftContent = document.createElement('div');
            leftContent.className = 'flex-1 min-w-0';
            
            const titleSpan = document.createElement('span');
            titleSpan.className = 'block truncate text-xs font-medium';
            titleSpan.textContent = entry.title;
            if (entry && entry.mode === 'event') { titleSpan.classList.add('event-title'); }

            
            // Add strikethrough if entry is checked
            if (entry.checked) {
                titleSpan.classList.add('entry-checked');
            }
            
            leftContent.appendChild(titleSpan);
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'text-xs flex-shrink-0 ml-2';
            timeSpan.textContent = formatTime12Hour(entry.time);
            
            contentDiv.appendChild(leftContent);
            contentDiv.appendChild(timeSpan);
            
            entryDiv.addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('dayModal').classList.add('hidden');
                openEditEntryModal(entry);
            });
            
            entryDiv.appendChild(priorityBar);
            entryDiv.appendChild(contentDiv);
            
            return entryDiv;
        }
        
        document.getElementById('closeDayModal').addEventListener('click', async () => {
            try { if (typeof saveToStorage === 'function') await saveToStorage(); } catch(e) {}
            document.getElementById('dayModal').classList.add('hidden');
        });
document.getElementById('addEntryFromDay').addEventListener('click', () => {
            document.getElementById('dayModal').classList.add('hidden');
        });
document.getElementById('dayModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('dayModal')) {
                document.getElementById('dayModal').classList.add('hidden');
            }
        });
        
        function startLongPressDetection(dateStr) {
            isLongPress = false;
            currentLongPressDate = dateStr;
            
            longPressTimer = setTimeout(() => {
                isLongPress = true;
                openDayModal(dateStr);
            }, 500);
        }
        
        function cancelLongPressDetection() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
        }
        
        function addLongPressListeners(element, dateStr) {
            element.addEventListener('mousedown', (e) => {
                if (e.target.closest('.calendar-entry')) { return; }
                e.preventDefault();
                startLongPressDetection(dateStr);
            });
            
            element.addEventListener('mouseup', () => { cancelLongPressDetection(); });
            element.addEventListener('mouseleave', () => { cancelLongPressDetection(); });
            
            element.addEventListener('touchstart', (e) => {
                if (e.target.closest('.calendar-entry')) { return; }
                e.preventDefault();
                startLongPressDetection(dateStr);
            });
            
            element.addEventListener('touchend', () => { cancelLongPressDetection(); });
            element.addEventListener('touchcancel', () => { cancelLongPressDetection(); });
        }

        function addDropZoneListeners(element, dateStr) {
            element.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (!element.classList.contains('drop-zone-hover')) {
                    element.classList.add('drop-zone-hover');
                }
            });
            
            element.addEventListener('dragenter', (e) => {
                e.preventDefault();
                element.classList.add('drop-zone-active');
            });
            
            element.addEventListener('dragleave', (e) => {
                e.preventDefault();
                if (!element.contains(e.relatedTarget)) {
                    element.classList.remove('drop-zone-hover');
                    element.classList.remove('drop-zone-active');
                }
            });
            
            element.addEventListener('drop', (e) => {
                e.preventDefault();
                element.classList.remove('drop-zone-hover');
                element.classList.remove('drop-zone-active');
                
                const entryId = e.dataTransfer.getData('text/plain');
                if (entryId) { moveEntryToDate(entryId, dateStr); }
            });
        }
        
        function moveEntryToDate(entryId, newDateStr) {
            const entryIndex = calendarEntries.findIndex(entry => entry.id == entryId);
            if (entryIndex !== -1) {
                const entry = calendarEntries[entryIndex];
                const oldDate = entry.date;
                
                calendarEntries[entryIndex].date = newDateStr;
                
                refreshCalendarDisplay();
                saveToStorage();
                showDropNotification(entry.title, oldDate, newDateStr);
            }
        }
        
        function showDropNotification(entryTitle, oldDate, newDate) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
            notification.style.transform = 'translateX(100%)';
            
            const oldDateFormatted = formatDateForNotification(oldDate);
            const newDateFormatted = formatDateForNotification(newDate);
            
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-sm font-medium">
                        "${entryTitle}" moved to ${newDateFormatted}
                    </span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => { notification.style.transform = 'translateX(0)'; }, 10);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) { document.body.removeChild(notification); }
                }, 300);
            }, 3000);
        }
        
        function formatDateForNotification(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            const day = date.getDate();
            const month = monthNames[date.getMonth()];
            return `${day} ${month}`;
        }

        let selectedCardType = 'task';

        document.getElementById('cancelCardModal').addEventListener('click', () => {
            document.getElementById('addCardModal').classList.add('hidden');
            resetCardSelection();
        });

        document.getElementById('addCardModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('addCardModal')) {
                document.getElementById('addCardModal').classList.add('hidden');
                resetCardSelection();
            }
        });

        document.getElementById('addTaskCard').addEventListener('click', () => {
            selectedCardType = 'task';
            updateCardTypeSelection();
        });

        document.getElementById('addEventCard').addEventListener('click', () => {
            selectedCardType = 'event';
            updateCardTypeSelection();
        });

        document.getElementById('addNoteCard').addEventListener('click', () => {
            selectedCardType = 'note';
            updateCardTypeSelection();
        });

        function updateCardTypeSelection() {
            document.getElementById('addTaskCard').className = 'flex flex-col items-center p-4 rounded-lg hover:bg-gray-50 transition-colors';
            document.getElementById('addEventCard').className = 'flex flex-col items-center p-4 rounded-lg hover:bg-gray-50 transition-colors';
            document.getElementById('addNoteCard').className = 'flex flex-col items-center p-4 rounded-lg hover:bg-gray-50 transition-colors';
            
            if (selectedCardType === 'task') {
                document.getElementById('addTaskCard').className = 'flex flex-col items-center p-4 rounded-lg bg-blue-100 border-2 border-blue-300 transition-colors';
            } else if (selectedCardType === 'event') {
                document.getElementById('addEventCard').className = 'flex flex-col items-center p-4 rounded-lg bg-green-100 border-2 border-green-300 transition-colors';
            } else if (selectedCardType === 'note') {
                document.getElementById('addNoteCard').className = 'flex flex-col items-center p-4 rounded-lg bg-purple-100 border-2 border-purple-300 transition-colors';
            }
            
            updateImportantCheckboxVisibility();
            
            setTimeout(() => { document.getElementById('cardTitle').focus(); }, 100);
        }

        function updateImportantCheckboxVisibility() {
            const importantContainer = document.getElementById('addCardImportantContainer');
            if (selectedCardType === 'note') {
                importantContainer.classList.remove('hidden');
            } else {
                importantContainer.classList.add('hidden');
                document.getElementById('addCardImportant').checked = false;
            }
        }

        function resetCardSelection() {
            selectedCardType = 'task';
            updateCardTypeSelection();
            document.getElementById('cardTitle').value = '';
            document.getElementById('addCardImportant').checked = false;
        }

        function forceTaskSelection() {
            selectedCardType = 'task';
            
            const taskCard = document.getElementById('addTaskCard');
            const eventCard = document.getElementById('addEventCard');
            const noteCard = document.getElementById('addNoteCard');
            
            taskCard.className = 'flex flex-col items-center p-4 rounded-lg bg-blue-100 border-2 border-blue-300 transition-colors';
            eventCard.className = 'flex flex-col items-center p-4 rounded-lg hover:bg-gray-50 transition-colors';
            noteCard.className = 'flex flex-col items-center p-4 rounded-lg hover:bg-gray-50 transition-colors';
            
            updateImportantCheckboxVisibility();
        }

        document.getElementById('saveCard').addEventListener('click', () => {
            const cardTitle = document.getElementById('cardTitle').value.trim();
            if (!cardTitle) {
                document.getElementById('cardTitle').focus();
                return;
            }
            
            const isImportant = selectedCardType === 'note' ? document.getElementById('addCardImportant').checked : false;
            
            const cardData = {
                id: 'card_' + Date.now() + Math.random(),
                title: cardTitle,
                type: selectedCardType,
                important: isImportant,
                createdAt: new Date().toISOString()
            };
            
            cards.push(cardData);
            
            const cardsContainer = document.getElementById('cardsContainer');
            const cardElement = createCardElement(cardData);
            cardsContainer.appendChild(cardElement);
            
            updateCardsArrayOrder();
            saveCardArrangement();
            saveToStorage();
            
            if (isImportant) { updateImportantSection(); }
            
            document.getElementById('addCardModal').classList.add('hidden');
            resetCardSelection();
        });

        document.getElementById('addCardModal').addEventListener('transitionend', () => {
            if (!document.getElementById('addCardModal').classList.contains('hidden')) {
                setTimeout(() => { document.getElementById('cardTitle').focus(); }, 100);
            }
        });

        document.getElementById('cancelEditCard').addEventListener('click', () => {
            document.getElementById('editCardModal').classList.add('hidden');
            editingCard = null;
        });

        document.getElementById('editCardModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('editCardModal')) {
                document.getElementById('editCardModal').classList.add('hidden');
                editingCard = null;
            }
        });

        document.getElementById('saveEditCard').addEventListener('click', () => {
            const cardTitle = document.getElementById('editCardTitle').value.trim();
            if (!cardTitle || !editingCard) { return; }
            
            const isImportant = editingCard.type === 'note' ? document.getElementById('editCardImportant').checked : false;
            
            // IMMEDIATE MEMORY UPDATE - Find and update the card in the cards array RIGHT NOW
            const cardIndex = cards.findIndex(card => card.id === editingCard.id);
            if (cardIndex !== -1) {
                const oldTitle = cards[cardIndex].title;
                const oldImportant = cards[cardIndex].important || false;
                
                // STEP 1: Update the cards array IMMEDIATELY
                cards[cardIndex].title = cardTitle;
                cards[cardIndex].important = isImportant;
                
                // STEP 2: Update the editingCard object IMMEDIATELY  
                editingCard.title = cardTitle;
                editingCard.important = isImportant;
                
                // STEP 3: Update ALL calendar entries that reference the old card name IMMEDIATELY
                calendarEntries.forEach(entry => {
                    if (entry.card === oldTitle) { 
                        entry.card = cardTitle; 
                    }
                });
                
                // STEP 4: Update the DOM elements IMMEDIATELY
                const cardElement = document.querySelector(`[data-card-id="${editingCard.id}"]`);
                if (cardElement) {
                    // Update the displayed title
                    const titleElement = cardElement.querySelector('.card-title, h3');
                    if (titleElement) { 
                        titleElement.textContent = cardTitle; 
                    }
                    
                    // Update the entries container ID for non-note cards
                    if (editingCard.type !== 'note') {
                        const entriesContainer = cardElement.querySelector('.card-entries-container');
                        if (entriesContainer) { 
                            entriesContainer.id = `${cardTitle}EntriesList`; 
                        }
                    }
                    
                    updateCardImportantStatus(cardElement, editingCard.type, isImportant, oldImportant);
                }
                
                // STEP 5: Save to storage IMMEDIATELY
                saveToStorage();
                
                // STEP 6: Update displays
                updateCardsArrayOrder();
                if (editingCard.type === 'note') { 
                    updateImportantSection(); 
                }
                updateAllCardEntries();
                refreshCalendarDisplay();
            }
            
            document.getElementById('editCardModal').classList.add('hidden');
            editingCard = null;
        });

        function updateCardImportantStatus(cardElement, cardType, isImportant, oldImportant) {
            if (cardType !== 'note') return;
            
            const titleContainer = cardElement.querySelector('.flex.items-center');
            const starElement = titleContainer?.querySelector('.text-red-500.text-xs.font-bold');
            
            if (isImportant && !starElement) {
                const star = document.createElement('span');
                star.className = 'ml-2 text-red-500 text-xs font-bold';
                star.textContent = '★';
                titleContainer.appendChild(star);
            } else if (!isImportant && starElement) {
                starElement.remove();
            }
            
            const borderClasses = ['border-purple-500', 'border-red-500', 'border-2'];
            cardElement.classList.remove(...borderClasses);
            
            if (isImportant) {
                cardElement.classList.add('border-red-500', 'border-2');
            } else {
                cardElement.classList.add('border-purple-500');
            }
        }

        function editCard(cardData) {
            editingCard = cardData;
            document.getElementById('editCardTitle').value = cardData.title;
            
            const editImportantContainer = document.getElementById('editCardImportantContainer');
            if (cardData.type === 'note') {
                editImportantContainer.classList.remove('hidden');
                document.getElementById('editCardImportant').checked = cardData.important || false;
            } else {
                editImportantContainer.classList.add('hidden');
                document.getElementById('editCardImportant').checked = false;
            }
            
            document.getElementById('editCardModal').classList.remove('hidden');
            
            setTimeout(() => { document.getElementById('editCardTitle').focus(); }, 100);
        }

        function deleteCard(cardData) {
            const defaultCard = cardData.type === 'task' ? 'T0' : 'E0';
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4 text-gray-900">Delete ${cardData.title} Card</h3>
                    <p class="text-gray-600 mb-4">Delete ${cardData.title} and reassign its entries to ${defaultCard}.</p>
                    <div class="flex justify-end space-x-3">
                        <button class="flex items-center justify-center w-10 h-10 text-gray-600 hover:bg-gray-100 rounded-md transition-colors cancel-delete" title="Cancel">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                        <button class="flex items-center justify-center w-10 h-10 bg-red-500 text-white hover:bg-red-600 rounded-md transition-colors confirm-delete" title="Delete">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>
            `;
            
            modal.querySelector('.cancel-delete').addEventListener('click', () => {
                document.body.removeChild(modal);
            });
            
            modal.querySelector('.confirm-delete').addEventListener('click', () => {
                const cardIndex = cards.findIndex(card => card.id === cardData.id);
                if (cardIndex !== -1) { cards.splice(cardIndex, 1); }
                
                const defaultCard = cardData.type === 'task' ? 'T0' : 'E0';
                calendarEntries.forEach(entry => {
                    if (entry.card === cardData.title) { entry.card = defaultCard; }
                });
                
                const cardElement = document.querySelector(`[data-card-id="${cardData.id}"]`);
                if (cardElement) { cardElement.remove(); }
                
                updateCardsArrayOrder();
                updateImportantSection();
                refreshCalendarDisplay();
                updateAllCardEntries();
                saveToStorage();
                
                document.body.removeChild(modal);
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) { document.body.removeChild(modal); }
            });
            
            document.body.appendChild(modal);
        }

        let customAlarmPickerCurrentDate = new Date();

        function openSetAlarmModal() {
            const entryDate = document.getElementById('entryDate').value;
            const entryTitle = document.getElementById('entryTitle').value;
            const entryTime = document.getElementById('entryTime').value;
            
            let displayText = '';
            if (entryTitle.trim()) {
                displayText = entryTitle.trim();
            } else {
                displayText = 'No title';
            }
            
            if (entryDate) {
                const date = new Date(entryDate + 'T00:00:00');
                const day = date.getDate();
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                const dayOfWeek = dayNames[date.getDay()];
                displayText += `: ${day} ${month} ${year} [${dayOfWeek}]`;
            }
            
            document.getElementById('alarmEntryTitleDisplay').textContent = displayText;
            
            if (entryDate) {
                const entryDateObj = new Date(entryDate + 'T12:00:00');
                entryDateObj.setDate(entryDateObj.getDate() - 1);
                const presetAlarmDate = entryDateObj.toISOString().split('T')[0];
                document.getElementById('customAlarmDateInput').value = presetAlarmDate;
                updateCustomAlarmDateDisplay();
            }
            
            populateCustomAlarmTimeOptions();
            
            if (entryTime) { document.getElementById('customAlarmTime').value = entryTime; }
            
            document.getElementById('setAlarmModal').classList.remove('hidden');
            
            setTimeout(() => { document.getElementById('customAlarmDateDisplay').focus(); }, 100);
        }

        function populateCustomAlarmTimeOptions() {
            const timeSelect = document.getElementById('customAlarmTime');
            timeSelect.innerHTML = '';
            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    const time24 = `${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`;
                    let hour12 = hour;
                    let ampm = 'am';
                    if (hour === 0) {
                        hour12 = 12;
                    } else if (hour === 12) {
                        ampm = 'pm';
                    } else if (hour > 12) {
                        hour12 = hour - 12;
                        ampm = 'pm';
                    }
                    const time12 = `${hour12.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')} ${ampm}`;
                    const option = document.createElement('option');
                    option.value = time24;
                    option.textContent = time12;
                    timeSelect.appendChild(option);
                }
            }
        }

        function updateCustomAlarmDateDisplay() {
            const alarmDateInput = document.getElementById('customAlarmDateInput');
            const alarmDateDisplayText = document.querySelector('#customAlarmDateDisplay span');
            if (alarmDateInput.value) {
                const date = new Date(alarmDateInput.value + 'T00:00:00');
                const day = date.getDate();
                const month = monthNames[date.getMonth()];
                const year = date.getFullYear();
                const dayNames = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
                const dayOfWeek = dayNames[date.getDay()];
                alarmDateDisplayText.textContent = `${day} ${month} ${year} [${dayOfWeek}]`;
            } else {
                alarmDateDisplayText.textContent = 'Select Alarm Date';
            }
        }

        function openCustomAlarmDatePicker() {
            const customAlarmPicker = document.getElementById('customAlarmDatePicker');
            const currentValue = document.getElementById('customAlarmDateInput').value;
            if (currentValue) {
                customAlarmPickerCurrentDate = new Date(currentValue + 'T00:00:00');
            } else {
                customAlarmPickerCurrentDate = new Date();
            }
            generateCustomAlarmPickerCalendar();
            customAlarmPicker.classList.remove('hidden');
        }

        function generateCustomAlarmPickerCalendar() {
            const year = customAlarmPickerCurrentDate.getFullYear();
            const month = customAlarmPickerCurrentDate.getMonth();
            const customAlarmPickerGrid = document.getElementById('customAlarmPickerCalendarGrid');
            const customAlarmPickerMonthElement = document.getElementById('customAlarmPickerMonth');
            customAlarmPickerMonthElement.textContent = `${monthNames[month]} ${year}`;
            customAlarmPickerGrid.innerHTML = '';
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            const mondayOffset = startDay === 0 ? 6 : startDay - 1;
            for (let i = 0; i < mondayOffset; i++) {
                const cell = document.createElement('div');
                cell.className = 'h-8 w-8';
                customAlarmPickerGrid.appendChild(cell);
            }
            const today = new Date();
            const selectedValue = document.getElementById('customAlarmDateInput').value;
            let selectedDate = null;
            if (selectedValue) { selectedDate = new Date(selectedValue + 'T00:00:00'); }
            for (let day = 1; day <= daysInMonth; day++) {
                const cell = document.createElement('div');
                const cellDate = new Date(year, month, day);
                const isToday = year === today.getFullYear() && month === today.getMonth() && day === today.getDate();
                const isSelected = selectedDate && year === selectedDate.getFullYear() && month === selectedDate.getMonth() && day === selectedDate.getDate();
                cell.className = `h-8 w-8 flex items-center justify-center text-sm cursor-pointer rounded transition-colors ${
                    isSelected 
                        ? 'bg-red-500 text-white font-semibold' 
                        : isToday 
                            ? 'bg-red-100 text-red-700 font-semibold hover:bg-red-200'
                            : 'hover:bg-gray-100 text-gray-700'
                }`;
                cell.textContent = day;
                cell.addEventListener('click', () => {
                    const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                cell.setAttribute("data-date", dateStr);
                    document.getElementById('customAlarmDateInput').value = dateStr;
                    updateCustomAlarmDateDisplay();
                    document.getElementById('customAlarmDatePicker').classList.add('hidden');
                });
                customAlarmPickerGrid.appendChild(cell);
            }
        }

        document.getElementById('cancelCustomAlarm').addEventListener('click', () => {
            document.getElementById('setAlarmModal').classList.add('hidden');
            const alarmOptions = document.getElementById('alarmOptions');
            if (alarmOptions.dataset.previousValue) {
                alarmOptions.value = alarmOptions.dataset.previousValue;
                updateAlarmDisplay();
            }
        });

        document.getElementById('saveCustomAlarm').addEventListener('click', () => {
            const customAlarmDate = document.getElementById('customAlarmDateInput').value;
            const customAlarmTime = document.getElementById('customAlarmTime').value;
            
            if (customAlarmDate && customAlarmTime) {
                document.getElementById('alarmOptions').value = 'custom';
                document.getElementById('alarmDate').value = customAlarmDate;
                
                const alarmDateInput = document.getElementById('alarmDate');
                if (alarmDateInput) { alarmDateInput.dataset.customAlarmTime = customAlarmTime; }
                
                updateAlarmDateDisplay();
                updateAlarmDisplay();
                updateSaveButtonState();
                
                document.getElementById('setAlarmModal').classList.add('hidden');
            }
        });

        document.getElementById('setAlarmModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('setAlarmModal')) {
                document.getElementById('setAlarmModal').classList.add('hidden');
                const alarmOptions = document.getElementById('alarmOptions');
                if (alarmOptions.dataset.previousValue) {
                    alarmOptions.value = alarmOptions.dataset.previousValue;
                    updateAlarmDisplay();
                }
            }
        });

        document.getElementById('customAlarmDateDisplay').addEventListener('click', (e) => {
            e.stopPropagation();
            const customAlarmPicker = document.getElementById('customAlarmDatePicker');
            if (customAlarmPicker.classList.contains('hidden')) {
                openCustomAlarmDatePicker();
            } else {
                customAlarmPicker.classList.add('hidden');
            }
        });

        document.getElementById('customAlarmDateInput').addEventListener('click', (e) => {
            e.stopPropagation();
            const customAlarmPicker = document.getElementById('customAlarmDatePicker');
            if (customAlarmPicker.classList.contains('hidden')) {
                openCustomAlarmDatePicker();
            } else {
                customAlarmPicker.classList.add('hidden');
            }
        });

        document.getElementById('customAlarmDateInput').addEventListener('change', () => {
            updateCustomAlarmDateDisplay();
        });

        document.getElementById('prevCustomAlarmPickerMonth').addEventListener('click', (e) => {
            e.stopPropagation();
            customAlarmPickerCurrentDate.setMonth(customAlarmPickerCurrentDate.getMonth() - 1);
            generateCustomAlarmPickerCalendar();
        });

        document.getElementById('nextCustomAlarmPickerMonth').addEventListener('click', (e) => {
            e.stopPropagation();
            customAlarmPickerCurrentDate.setMonth(customAlarmPickerCurrentDate.getMonth() + 1);
            generateCustomAlarmPickerCalendar();
        });

        document.addEventListener('click', (e) => {
            const customAlarmPicker = document.getElementById('customAlarmDatePicker');
            const customAlarmPickerContainer = document.querySelector('#customAlarmDateDisplay')?.closest('.relative');
            const isClickInsideCustomAlarmPickerArea = customAlarmPickerContainer && (customAlarmPickerContainer.contains(e.target) || customAlarmPicker.contains(e.target));
            if (!isClickInsideCustomAlarmPickerArea && !customAlarmPicker.classList.contains('hidden')) {
                customAlarmPicker.classList.add('hidden');
            }
        });

        function addCardDragListeners(cardElement, cardData) {
            const dragHandle = cardElement.querySelector('.card-drag-handle');
            if (!dragHandle) return;
            
            dragHandle.draggable = true;
            
            dragHandle.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', cardData.id);
                e.dataTransfer.effectAllowed = 'move';
                cardElement.classList.add('dragging-card');
                
                cardElement.style.opacity = '0.5';
                cardElement.style.transform = 'rotate(2deg) scale(0.95)';
            });
            
            dragHandle.addEventListener('dragend', (e) => {
                cardElement.classList.remove('dragging-card');
                cardElement.style.opacity = '';
                cardElement.style.transform = '';
                
                document.querySelectorAll('.note-item').forEach(card => {
                    card.classList.remove('card-reorder-drop-zone-active', 'card-reorder-drop-zone-hover');
                });
            });
            
            cardElement.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                
                if (!cardElement.classList.contains('dragging-card')) {
                    cardElement.classList.add('card-reorder-drop-zone-hover');
                }
            });
            
            cardElement.addEventListener('dragenter', (e) => {
                e.preventDefault();
                if (!cardElement.classList.contains('dragging-card')) {
                    cardElement.classList.add('card-reorder-drop-zone-active');
                }
            });
            
            cardElement.addEventListener('dragleave', (e) => {
                if (!cardElement.contains(e.relatedTarget)) {
                    cardElement.classList.remove('card-reorder-drop-zone-hover', 'card-reorder-drop-zone-active');
                }
            });
            
            cardElement.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                const draggedCardId = e.dataTransfer.getData('text/plain');
                if (draggedCardId && draggedCardId !== cardData.id) {
                    reorderCards(draggedCardId, cardData.id);
                }
                
                cardElement.classList.remove('card-reorder-drop-zone-hover', 'card-reorder-drop-zone-active');
            });
        }

        function reorderCards(draggedCardId, targetCardId) {
            const cardsContainer = document.getElementById('cardsContainer');
            const draggedElement = document.querySelector(`[data-card-id="${draggedCardId}"]`);
            const targetElement = document.querySelector(`[data-card-id="${targetCardId}"]`);
            
            if (!draggedElement || !targetElement) return;
            
            const allCardElements = Array.from(cardsContainer.children);
            
            const draggedIndex = allCardElements.indexOf(draggedElement);
            const targetIndex = allCardElements.indexOf(targetElement);
            
            if (draggedIndex === -1 || targetIndex === -1) return;
            
            if (draggedIndex < targetIndex) {
                targetElement.parentNode.insertBefore(draggedElement, targetElement.nextSibling);
            } else {
                targetElement.parentNode.insertBefore(draggedElement, targetElement);
            }
            
            updateCardsArrayOrder();
            saveCardArrangement();
            
            const draggedCard = cards.find(card => card.id === draggedCardId);
            const targetCard = cards.find(card => card.id === targetCardId);
            
            if (draggedCard && targetCard) {
                showCardReorderNotification(draggedCard.title, targetCard.title);
            }
            
            saveToStorage();
        }

        function saveCardArrangement() {
            const cardsContainer = document.getElementById('cardsContainer');
            const cardElements = Array.from(cardsContainer.children);
            
            const arrangement = [];
            
            cardElements.forEach((element, index) => {
                const titleElement = element.querySelector('h3, .card-title');
                const cardId = element.dataset.cardId;
                
                if (titleElement) {
                    const title = titleElement.textContent.trim();
                    
                    arrangement.push({
                        id: cardId || (title === 'T0' ? 'default_t0' : title === 'E0' ? 'default_e0' : title),
                        title: title,
                        position: index,
                        isDefault: title === 'T0' || title === 'E0'
                    });
                }
            });
            
            const arrangementData = {
                arrangement: arrangement,
                timestamp: new Date().toISOString()
            };
            
            try {
                localStorage.setItem('toto_card_arrangement', JSON.stringify(arrangementData));
            } catch (e) {
                document.cookie = `toto_arrangement=${encodeURIComponent(JSON.stringify(arrangementData))}; expires=Fri, 31 Dec 2099 23:59:59 UTC; path=/;`;
            }
        }
        
        function loadCardArrangement() {
            let arrangementData = null;
            
            try {
                const stored = localStorage.getItem('toto_card_arrangement');
                if (stored) { arrangementData = JSON.parse(stored); }
            } catch (e) {
                const getCookie = (name) => {
                    const value = `; ${document.cookie}`;
                    const parts = value.split(`; ${name}=`);
                    if (parts.length === 2) return decodeURIComponent(parts.pop().split(';').shift());
                    return null;
                };
                
                const cookieData = getCookie('toto_arrangement');
                if (cookieData) {
                    try { arrangementData = JSON.parse(cookieData); } catch (e) {}
                }
            }
            
            if (arrangementData && arrangementData.arrangement) {
                return arrangementData.arrangement.sort((a, b) => a.position - b.position);
            }
            
            return null;
        }
        
        function updateCardsArrayOrder() {
            const cardsContainer = document.getElementById('cardsContainer');
            const cardElements = Array.from(cardsContainer.children);
            
            const reorderedCards = [];
            
            cardElements.forEach(element => {
                const titleElement = element.querySelector('h3, .card-title');
                const cardId = element.dataset.cardId;
                
                if (titleElement) {
                    const title = titleElement.textContent.trim();
                    
                    if (title === 'T0' || title === 'E0') {
                        let card = cards.find(c => c.title === title);
                        if (!card) {
                            card = {
                                id: title === 'T0' ? 'default_t0' : 'default_e0',
                                title: title,
                                type: title === 'T0' ? 'task' : 'event',
                                isDefault: true,
                                createdAt: new Date().toISOString()
                            };
                        }
                        reorderedCards.push(card);
                    } else {
                        if (cardId) {
                            const card = cards.find(c => c.id === cardId);
                            if (card) { reorderedCards.push(card); }
                        }
                    }
                }
            });
            
            cards.length = 0;
            cards.push(...reorderedCards);
        }

        function showCardReorderNotification(draggedTitle, targetTitle) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
            notification.style.transform = 'translateX(100%)';
            
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                    </svg>
                    <span class="text-sm font-medium">
                        "${draggedTitle}" moved near "${targetTitle}"
                    </span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => { notification.style.transform = 'translateX(0)'; }, 10);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) { document.body.removeChild(notification); }
                }, 300);
            }, 3000);
        }

        function createCardElement(cardData) {
            const cardElement = document.createElement('div');
            cardElement.className = 'note-item bg-white p-4 rounded-lg border relative';
            cardElement.dataset.cardId = cardData.id;
            
            let iconColor, textColor, borderColor;
            if (cardData.type === 'task') {
                iconColor = 'text-blue-600';
                textColor = 'text-blue-800';
                borderColor = 'border-blue-500';
            } else if (cardData.type === 'event') {
                iconColor = 'text-green-600';
                textColor = 'text-green-800';
                borderColor = 'border-green-500';
            } else {
                iconColor = 'text-purple-600';
                textColor = 'text-purple-800';
                borderColor = 'border-purple-500';
            }
            
            cardElement.classList.add(borderColor);
            
            if (cardData.important) {
                cardElement.classList.remove(borderColor);
                cardElement.classList.add('border-red-500', 'border-2');
            }
            
            let cardContent;
            
            if (cardData.type === 'note') {
                cardContent = `
                    <div class="flex items-center justify-between mb-1 card-drag-handle rounded p-2 -m-2">
                        <div class="flex items-center">
                            ${getCardIcon(cardData.type, iconColor)}
                            <h3 class="font-semibold ${textColor} card-title">${cardData.title}</h3>
                            ${cardData.important ? '<span class="ml-2 text-red-500 text-xs font-bold">★</span>' : ''}
                        </div>
                        <div class="flex items-center space-x-1">
                            <button class="edit-card-btn p-1 text-gray-400 hover:text-blue-500 rounded transition-colors" title="Edit Card">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="delete-card-btn p-1 text-gray-400 hover:text-red-500 rounded transition-colors" title="Delete Card">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="note-content-area card-entries-container cursor-text rounded p-2 min-h-[200px] transition-colors ${cardData.content && cardData.content.trim() ? 'block' : 'flex items-center justify-center'}" title="Click to edit notes">
                        <div class="note-content-display ${cardData.content && cardData.content.trim() ? 'text-sm text-gray-700 whitespace-pre-wrap w-full' : 'text-center'}">${cardData.content && cardData.content.trim() ? `<div class="text-left text-sm text-gray-700 whitespace-pre-wrap leading-tight">${cardData.content}</div>` : '<span class="text-gray-500 text-xs italic">Click here to add notes</span>'}</div>
                        <textarea class="note-content-editor hidden text-base w-full h-full resize-none border-none outline-none bg-transparent" placeholder="Add your notes here..."></textarea>
                    </div>
                `;
            } else {
                cardContent = `
                    <div class="flex items-center justify-between mb-1 card-drag-handle rounded p-2 -m-2">
                        <div class="flex items-center">
                            ${getCardIcon(cardData.type, iconColor)}
                            <h3 class="font-semibold ${textColor} card-title">${cardData.title}</h3>
                            ${cardData.important ? '<span class="ml-2 text-red-500 text-xs font-bold">★</span>' : ''}
                        </div>
                        <div class="flex items-center space-x-1">
                            <button class="edit-card-btn p-1 text-gray-400 hover:text-blue-500 rounded transition-colors" title="Edit Card">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                </svg>
                            </button>
                            <button class="delete-card-btn p-1 text-gray-400 hover:text-red-500 rounded transition-colors" title="Delete Card">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div id="${cardData.title}EntriesList" class="space-y-1 card-entries-container">
                    </div>
                `;
            }
            
            cardElement.innerHTML = cardContent;
            
            const editBtn = cardElement.querySelector('.edit-card-btn');
            const deleteBtn = cardElement.querySelector('.delete-card-btn');
            
            editBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                editCard(cardData);
            });
            
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteCard(cardData);
            });
            
            addCardDragListeners(cardElement, cardData);
            
            if (cardData.type === 'note') {
                setupNoteEditing(cardElement, cardData);
            } else {
                setupSingleCardDropZone(cardElement);
                setupCardClickToAddEntry(cardElement, cardData);
            }
            
            return cardElement;
        }

        function getCardIcon(type, colorClass) {
            if (type === 'task') {
                return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${colorClass} mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                </svg>`;
            } else if (type === 'event') {
                return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${colorClass} mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>`;
            } else {
                return `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${colorClass} mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                </svg>`;
            }
        }

        function loadSavedCards() {
            const cardsContainer = document.getElementById('cardsContainer');
            
            cardsContainer.innerHTML = '';
            
            const savedArrangement = loadCardArrangement();
            
            if (savedArrangement && savedArrangement.length > 0) {
                savedArrangement.forEach(arrangementItem => {
                    let cardElement;
                    
                    if (arrangementItem.title === 'T0') {
                        cardElement = document.createElement('div');
                        cardElement.className = 'note-item bg-gray-100 p-3 rounded-lg border border-gray-300';
                        cardElement.dataset.cardId = 'default_t0';
                        cardElement.innerHTML = `
                            <div class="flex items-center mb-1 card-drag-handle rounded p-2 -m-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                                </svg>
                                <h3 class="font-semibold text-blue-800">T0</h3>
                            </div>
                            <div id="taskEntriesList" class="space-y-1 card-entries-container">
                            </div>
                        `;
                        
                        const t0CardData = { id: 'default_t0', title: 'T0', type: 'task', isDefault: true };
                        addCardDragListeners(cardElement, t0CardData);
                        setupSingleCardDropZone(cardElement);
                        setupCardClickToAddEntry(cardElement, t0CardData);
                        
                        cardsContainer.appendChild(cardElement);
                        
                    } else if (arrangementItem.title === 'E0') {
                        cardElement = document.createElement('div');
                        cardElement.className = 'note-item bg-gray-100 p-3 rounded-lg border border-gray-300';
                        cardElement.dataset.cardId = 'default_e0';
                        cardElement.innerHTML = `
                            <div class="flex items-center mb-1 card-drag-handle rounded p-2 -m-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <h3 class="font-semibold text-green-800">E0</h3>
                            </div>
                            <div id="eventEntriesList" class="space-y-1 card-entries-container">
                            </div>
                        `;
                        
                        const e0CardData = { id: 'default_e0', title: 'E0', type: 'event', isDefault: true };
                        addCardDragListeners(cardElement, e0CardData);
                        setupSingleCardDropZone(cardElement);
                        setupCardClickToAddEntry(cardElement, e0CardData);
                        
                        cardsContainer.appendChild(cardElement);
                        
                    } else {
                        const cardData = cards.find(card => card.id === arrangementItem.id || card.title === arrangementItem.title);
                        if (cardData) {
                            cardElement = createCardElement(cardData);
                            cardsContainer.appendChild(cardElement);
                        }
                    }
                });
                
                updateCardsArrayOrder();
                
            } else if (cards.length > 0) {
                cards.forEach(cardData => {
                    let cardElement;
                    
                    if (cardData.title === 'T0') {
                        cardElement = document.createElement('div');
                        cardElement.className = 'note-item bg-gray-100 p-3 rounded-lg border border-gray-300';
                        cardElement.dataset.cardId = 'default_t0';
                        cardElement.innerHTML = `
                            <div class="flex items-center mb-1 card-drag-handle rounded p-2 -m-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                                </svg>
                                <h3 class="font-semibold text-blue-800">T0</h3>
                            </div>
                            <div id="taskEntriesList" class="space-y-1 card-entries-container">
                            </div>
                        `;
                        
                        const t0CardData = { id: 'default_t0', title: 'T0', type: 'task' };
                        addCardDragListeners(cardElement, t0CardData);
                        setupSingleCardDropZone(cardElement);
                    } else if (cardData.title === 'E0') {
                        cardElement = document.createElement('div');
                        cardElement.className = 'note-item bg-gray-100 p-3 rounded-lg border border-gray-300';
                        cardElement.dataset.cardId = 'default_e0';
                        cardElement.innerHTML = `
                            <div class="flex items-center mb-1 card-drag-handle rounded p-2 -m-2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                                </svg>
                                <h3 class="font-semibold text-green-800">E0</h3>
                            </div>
                            <div id="eventEntriesList" class="space-y-1 card-entries-container">
                            </div>
                        `;
                        
                        const e0CardData = { id: 'default_e0', title: 'E0', type: 'event' };
                        addCardDragListeners(cardElement, e0CardData);
                        setupSingleCardDropZone(cardElement);
                    } else {
                        cardElement = createCardElement(cardData);
                    }
                    
                    cardsContainer.appendChild(cardElement);
                });
                
                saveCardArrangement();
                
            } else {
                const t0Card = document.createElement('div');
                t0Card.className = 'note-item bg-gray-100 p-3 rounded-lg border border-gray-300';
                t0Card.dataset.cardId = 'default_t0';
                t0Card.innerHTML = `
                    <div class="flex items-center mb-1 card-drag-handle rounded p-2 -m-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-blue-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                        <h3 class="font-semibold text-blue-800">T0</h3>
                    </div>
                    <div id="taskEntriesList" class="space-y-1 card-entries-container">
                    </div>
                `;
                
                const e0Card = document.createElement('div');
                e0Card.className = 'note-item bg-gray-100 p-3 rounded-lg border border-gray-300';
                e0Card.dataset.cardId = 'default_e0';
                e0Card.innerHTML = `
                    <div class="flex items-center mb-1 card-drag-handle rounded p-2 -m-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-600 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <h3 class="font-semibold text-green-800">E0</h3>
                    </div>
                    <div id="eventEntriesList" class="space-y-1 card-entries-container">
                    </div>
                `;
                
                const t0CardData = { id: 'default_t0', title: 'T0', type: 'task', isDefault: true, createdAt: new Date().toISOString() };
                const e0CardData = { id: 'default_e0', title: 'E0', type: 'event', isDefault: true, createdAt: new Date().toISOString() };
                
                addCardDragListeners(t0Card, t0CardData);
                setupSingleCardDropZone(t0Card);
                addCardDragListeners(e0Card, e0CardData);
                setupSingleCardDropZone(e0Card);
                
                cardsContainer.appendChild(t0Card);
                cardsContainer.appendChild(e0Card);
                
                cards.push(t0CardData, e0CardData);
                
                saveCardArrangement();
                saveToStorage();
            }
            
            setupCardDropZones();
        }

        function setupSingleCardDropZone(cardElement) {
            // compute card title dynamically at drop time to ensure latest card name is used
            const cardType = getCardType(cardElement);
            
            if (cardType === 'note') { return; }
            
            cardElement.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
                if (!cardElement.classList.contains('card-drop-zone-hover')) {
                    cardElement.classList.add('card-drop-zone-hover');
                }
            });
            
            cardElement.addEventListener('dragenter', (e) => {
                e.preventDefault();
                cardElement.classList.add('card-drop-zone-active');
            });
            
            cardElement.addEventListener('dragleave', (e) => {
                cardElement.classList.remove('card-drop-zone-active');
                cardElement.classList.remove('card-drop-zone-hover');
            });
            
            cardElement.addEventListener('drop', (e) => {
                e.preventDefault();
                cardElement.classList.remove('card-drop-zone-hover');
                cardElement.classList.remove('card-drop-zone-active');
                
                const entryId = e.dataTransfer.getData('text/plain');
                if (entryId) { 
                    // get current title from DOM (fresh) in case the card has been renamed
                    const currentCardTitle = getCardTitle(cardElement);
                    moveEntryToCard(entryId, currentCardTitle); 
                }
            });
        }

        function setupCardDropZones() {
            const allCards = document.querySelectorAll('.note-item');
            
            allCards.forEach(card => {
                setupSingleCardDropZone(card);
            });
        }

        function getCardTitle(cardElement) {
            const titleElement = cardElement.querySelector('h3');
            if (titleElement) { return titleElement.textContent.trim(); }
            
            const cardTitleElement = cardElement.querySelector('.card-title');
            if (cardTitleElement) { return cardTitleElement.textContent.trim(); }
            
            return '';
        }

        function getCardType(cardElement) {
            const title = getCardTitle(cardElement);
            
            if (title === 'T0') return 'task';
            if (title === 'E0') return 'event';
            
            const taskIcon = cardElement.querySelector('svg path[d*="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"]');
            const eventIcon = cardElement.querySelector('svg path[d*="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"]');
            const noteIcon = cardElement.querySelector('svg path[d*="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"]');
            
            if (taskIcon) return 'task';
            if (eventIcon) return 'event';
            if (noteIcon) return 'note';
            
            return 'unknown';
        }

        function moveEntryToCard(entryId, targetCardTitle) {
            const entryIndex = calendarEntries.findIndex(entry => entry.id == entryId);
            if (entryIndex !== -1) {
                const entry = calendarEntries[entryIndex];
                const oldCard = entry.card || 'none';
                const oldMode = entry.mode;
                
                let targetCardType = null;
                if (targetCardTitle === 'T0') {
                    targetCardType = 'task';
                } else if (targetCardTitle === 'E0') {
                    targetCardType = 'event';
                } else {
                    const targetCard = cards.find(card => card.title === targetCardTitle);
                    if (targetCard) { targetCardType = targetCard.type; }
                }
                
                calendarEntries[entryIndex].card = targetCardTitle;
                
                if (targetCardType && targetCardType !== 'note') {
                    calendarEntries[entryIndex].mode = targetCardType;
                    
                    if (oldMode !== targetCardType) {
                        showCardDropNotificationWithTypeChange(entry.title, oldCard, targetCardTitle, oldMode, targetCardType);
                    } else {
                        showCardDropNotification(entry.title, oldCard, targetCardTitle);
                    }
                } else {
                    showCardDropNotification(entry.title, oldCard, targetCardTitle);
                }
                
                updateAllCardEntries();
                saveToStorage();
            }
        }

        function showCardDropNotification(entryTitle, oldCard, newCard) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
            notification.style.transform = 'translateX(100%)';
            
            const oldCardDisplay = oldCard === 'none' || !oldCard ? 'default' : oldCard;
            
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    <span class="text-sm font-medium">
                        "${entryTitle}" moved to ${newCard}
                    </span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => { notification.style.transform = 'translateX(0)'; }, 10);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) { document.body.removeChild(notification); }
                }, 300);
            }, 3000);
        }

        function showCardDropNotificationWithTypeChange(entryTitle, oldCard, newCard, oldType, newType) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-blue-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300';
            notification.style.transform = 'translateX(100%)';
            
            const oldCardDisplay = oldCard === 'none' || !oldCard ? 'default' : oldCard;
            
            notification.innerHTML = `
                <div class="flex items-center space-x-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                    </svg>
                    <span class="text-sm font-medium">
                        "${entryTitle}" moved to ${newCard} (${oldType} → ${newType})
                    </span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => { notification.style.transform = 'translateX(0)'; }, 10);
            
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (document.body.contains(notification)) { document.body.removeChild(notification); }
                }, 300);
            }, 3000);
        }

        let alarmCheckInterval = null;
        let alarmSound = null;

        function generateAlarmSound() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const gainNode = audioContext.createGain();
                const oscillator = audioContext.createOscillator();
                
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime + 0.5);
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 3);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 3);
                
                return {
                    stop: () => {
                        try {
                            oscillator.stop();
                            audioContext.close();
                        } catch (e) {}
                    }
                };
            } catch(error){
                return {
                    stop: () => {}
                };
            }
        }

        function getAlarmDateTime(entry) {
            if (!entry.alarmOptions || entry.alarmOptions === 'none') {
                return null;
            }
            
            let alarmDate;
            let alarmTime;
            
            if (entry.alarmOptions === 'custom' && entry.alarmDate && entry.alarmTime) {
                alarmDate = entry.alarmDate;
                alarmTime = entry.alarmTime || '06:00';
            } else {
                alarmDate = calculateAlarmDate(entry.date, entry.alarmOptions);
                if (!alarmDate) return null;
                alarmTime = '06:00';
            }
            
            try {
                const alarmDateTime = new Date(alarmDate + 'T' + alarmTime + ':00');
                return alarmDateTime;
            } catch (error) {
                return null;
            }
        }

        function checkAlarms() {
            const now = new Date();
            const currentMinute = new Date(now.getFullYear(), now.getMonth(), now.getDate(), now.getHours(), now.getMinutes());
            
            calendarEntries.forEach(entry => {
                const alarmDateTime = getAlarmDateTime(entry);
                if (!alarmDateTime) return;
                
                const alarmMinute = new Date(alarmDateTime.getFullYear(), alarmDateTime.getMonth(), alarmDateTime.getDate(), alarmDateTime.getHours(), alarmDateTime.getMinutes());
                
                if (alarmMinute.getTime() === currentMinute.getTime()) {
                    showAlarmNotification(entry);
                }
            });
        }

        function showAlarmNotification(entry) {
            const alarmModal = document.getElementById('alarmNotificationModal');
            const entryTitle = document.getElementById('alarmEntryTitle');
            const entryDateTime = document.getElementById('alarmEntryDateTime');
            
            entryTitle.textContent = entry.title;
            
            const entryDate = new Date(entry.date + 'T00:00:00');
            const day = entryDate.getDate();
            const month = monthNames[entryDate.getMonth()];
            const year = entryDate.getFullYear();
            const time12Hour = formatTime12Hour(entry.time);
            entryDateTime.textContent = `${day} ${month} ${year}, ${time12Hour}`;
            
            alarmModal.classList.remove('hidden');
            
            alarmSound = generateAlarmSound();
            
            try {
                if ('vibrate' in navigator) {
                    navigator.vibrate([200, 100, 200, 100, 200]);
                }
            } catch (e) {}
        }

        document.getElementById('alarmOkButton').addEventListener('click', () => {
            document.getElementById('alarmNotificationModal').classList.add('hidden');
            if (alarmSound && alarmSound.stop) {
                alarmSound.stop();
                alarmSound = null;
            }
        });

        document.getElementById('alarmNotificationModal').addEventListener('click', (e) => {
            if (e.target === document.getElementById('alarmNotificationModal')) {
                document.getElementById('alarmNotificationModal').classList.add('hidden');
                if (alarmSound && alarmSound.stop) {
                    alarmSound.stop();
                    alarmSound = null;
                }
            }
        });

        function setupCardClickToAddEntry(cardElement, cardData) {
            if (cardData.type === 'note') return;
            
            const entriesContainer = cardElement.querySelector('.card-entries-container');
            if (!entriesContainer) return;
            
            entriesContainer.addEventListener('click', (e) => {
                if (e.target === entriesContainer || e.target.classList.contains('text-gray-500')) {
                    currentEntryMode = cardData.type;
                    resetModalForAdd();
                    populateCardDropdown();
                    document.getElementById('entryCard').value = cardData.title;
                    addEntryModal.classList.remove('hidden');
                }
            });
        }

        function setupNoteEditing(cardElement, cardData) {
            const noteContentArea = cardElement.querySelector('.note-content-area');
            const noteContentDisplay = cardElement.querySelector('.note-content-display');
            const noteContentEditor = cardElement.querySelector('.note-content-editor');
            
            if (!noteContentArea || !noteContentDisplay || !noteContentEditor) return;
            
            noteContentEditor.value = cardData.content || '';
            
            noteContentArea.addEventListener('click', (e) => {
                if (e.target.closest('.edit-card-btn') || e.target.closest('.delete-card-btn')) {
                    return;
                }
                
                startEditingNote(noteContentDisplay, noteContentEditor, cardData);
            });
            
            noteContentEditor.addEventListener('blur', () => {
                finishEditingNote(noteContentDisplay, noteContentEditor, cardData);
            });
            
            noteContentEditor.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    noteContentEditor.value = cardData.content || '';
                    finishEditingNote(noteContentDisplay, noteContentEditor, cardData);
                }
            });
        }

        function startEditingNote(displayElement, editorElement, cardData) {
            displayElement.classList.add('hidden');
            editorElement.classList.remove('hidden');
            editorElement.focus();
            
            editorElement.style.height = 'auto';
            editorElement.style.height = Math.max(200, editorElement.scrollHeight) + 'px';
        }

        function finishEditingNote(displayElement, editorElement, cardData) {
            const newContent = editorElement.value.trim();
            
            cardData.content = newContent;
            
            const cardIndex = cards.findIndex(card => card.id === cardData.id);
            if (cardIndex !== -1) {
                cards[cardIndex].content = newContent;
            }
            
            if (newContent) {
                displayElement.innerHTML = `<div class="text-left text-sm text-gray-700 whitespace-pre-wrap leading-tight">${newContent}</div>`;
            } else {
                displayElement.innerHTML = '<span class="text-gray-500 text-xs italic">Click here to add notes</span>';
            }
            
            displayElement.classList.remove('hidden');
            editorElement.classList.add('hidden');
            
            const parentContainer = displayElement.closest('.note-content-area');
            if (parentContainer) {
                if (newContent) {
                    parentContainer.classList.remove('flex', 'items-center', 'justify-center');
                    parentContainer.classList.add('block');
                } else {
                    parentContainer.classList.remove('block');
                    parentContainer.classList.add('flex', 'items-center', 'justify-center');
                }
            }
            
            updateImportantSection();
            saveToStorage();
        }

        function scrollToCurrentMonth() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const scrollContainer = document.getElementById('scrollCalendarContainer');
            const calendarGrid = scrollContainer ? scrollContainer.querySelector('.grid') : null;
            if (!calendarGrid) return;
            
            const cells = calendarGrid.children;
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                if (cell.dataset && Number(cell.dataset.year) === year && Number(cell.dataset.month) === month) {
                    cell.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    break;
                }
            }
        }

        function scrollToSpecificMonth(year, month) {
            const scrollContainer = document.getElementById('scrollCalendarContainer');
            const calendarGrid = scrollContainer.querySelector('.grid');
            
            if (!calendarGrid) return;
            
            const cells = calendarGrid.children;
            
            for (let i = 0; i < cells.length; i++) {
                const cell = cells[i];
                if (cell.dataset && Number(cell.dataset.year) === Number(year) && Number(cell.dataset.month) === Number(month)) {
                    cell.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    break;
                }
            }
        }

        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        async function initializeApp() {
            const storageReady = await initStorage();
            
            await loadFromStorage();
            // load persisted day alert settings (localStorage)
            loadDayAlertsFromLocalStorage();
            
            initializeDefaultCards();
            populateTimeOptions();
            initializeDefaultDates();
            
            showView('calendar');
            updateIconHighlight('calendar');
            updateToggleIcon();
            
            loadSavedCards();
            
            // Force default to Scroll View (override stored preference)
            isScrollView = true;

            if (isScrollView) {
                scrollView.classList.remove('hidden');
                monthView.classList.add('hidden');
                generateScrollCalendar();
                setTimeout(() => { scrollToCurrentMonth(); }, 100);
            } else {
                scrollView.classList.add('hidden');
                monthView.classList.remove('hidden');
                generateCalendar(currentDate.getFullYear(), currentDate.getMonth());
            }
            
            updateAllCardEntries();
            populateWelcomeModal();
            
            alarmCheckInterval = setInterval(checkAlarms, 60000);
            checkAlarms();
            
            setTimeout(() => {
                saveToStorage();
            }, 1000);
        }

        initializeApp();
    </script>
<script>
(function(){
  // Close Edit Card Modal on Save + enable Save only when title changed
  function initEditCardSaveControls(){
    const editCardModal = document.getElementById('editCardModal');
    const editCardTitleInput = document.getElementById('editCardTitle');
    const saveEditCardBtn = document.getElementById('saveEditCard');
    if (!editCardModal || !editCardTitleInput || !saveEditCardBtn) return;

    // Ensure button is type="button"
    try { saveEditCardBtn.type = 'button'; } catch(e){}

    // Helper to visually disable/enable
    function setDisabled(disabled){
      saveEditCardBtn.disabled = !!disabled;
      if (disabled){
        saveEditCardBtn.setAttribute('aria-disabled','true');
        saveEditCardBtn.classList.add('opacity-50','cursor-not-allowed');
      } else {
        saveEditCardBtn.removeAttribute('aria-disabled');
        saveEditCardBtn.classList.remove('opacity-50','cursor-not-allowed');
      }
    }

    // Initialize disabled
    setDisabled(true);
    let originalTitle = (editCardTitleInput.value || '').trim();

    // When modal is shown (hidden class removed), capture original title and reset button
    const mo = new MutationObserver(function(muts){
      muts.forEach(function(m){
        if (m.attributeName === 'class'){
          const isHidden = editCardModal.classList.contains('hidden');
          if (!isHidden){
            originalTitle = (editCardTitleInput.value || '').trim();
            setDisabled(true);
            // focus the title input a bit later
            setTimeout(function(){ try{ editCardTitleInput.focus(); editCardTitleInput.select(); }catch(e){} }, 20);
          }
        }
      });
    });
    mo.observe(editCardModal, { attributes: true });

    // Enable button only when title changed to non-empty and different
    editCardTitleInput.addEventListener('input', function(){
      const cur = (editCardTitleInput.value || '').trim();
      if (cur.length > 0 && cur !== originalTitle){
        setDisabled(false);
      } else {
        setDisabled(true);
      }
    });

    // Close modal immediately on click (capture phase so it runs first)
    saveEditCardBtn.addEventListener('click', function(e){
      if (saveEditCardBtn.disabled){
        e.preventDefault();
        return;
      }
      // Close modal immediately
      editCardModal.classList.add('hidden');
      // reset disabled state for next open
      setDisabled(true);
    }, true);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initEditCardSaveControls);
  } else {
    initEditCardSaveControls();
  }
})();

// Enable/disable Add Card save button based on title input
(function(){
  const saveCardBtn = document.getElementById('saveCard');
  const cardTitleInput = document.getElementById('cardTitle');
  if (saveCardBtn && cardTitleInput){
    function toggleSave(){
      const title = (cardTitleInput.value || '').trim();
      if (title.length > 0){
        saveCardBtn.disabled = false;
        saveCardBtn.setAttribute('aria-disabled', 'false');
        saveCardBtn.classList.remove('opacity-50','cursor-not-allowed');
      } else {
        saveCardBtn.disabled = true;
        saveCardBtn.setAttribute('aria-disabled', 'true');
        if (!saveCardBtn.classList.contains('opacity-50')){
          saveCardBtn.classList.add('opacity-50','cursor-not-allowed');
        }
      }
    }
    cardTitleInput.addEventListener('input', toggleSave);
    toggleSave();
  }
})();

</script>
<!-- injected by assistant: ensure navigation shows current month on startup (short month) -->
<script>
  (function(){
    try {
      function setNavMonth() { updateCurrentMonthLabel(); }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setNavMonth);
      } else {
        setNavMonth();
      }
    } catch (e) {
      console.error('Failed to set currentMonth navigation:', e);
    }
  })();
</script>
<!-- end injection -->

<!-- START TOTO: Weekend + Alert targeted ancestor-chain patch v8 -->
<script>
(function(){
  // Determine headerColor at runtime after DOM ready; fallback to '#f0f0f0'
  var headerColor = '#f0f0f0';
  function computeHeaderColor(){
    try{
      // Prefer a weekday header cell: attempt to pick the first weekday th if possible
      var th = document.querySelector('.calendar thead th:not(.weekend), .calendar thead th, .calendar th, thead th, th');
      if(th){
        var c = window.getComputedStyle(th).backgroundColor;
        if(c) headerColor = c;
      }
    }catch(e){}
  }

  function isLikelyColored(el){
    if(!el) return false;
    var cls = (el.className || '').toString();
    return /badge|priority|category|bg-|text-|label|tag|dot|icon/.test(cls);
  }
  function setInlineBg(el, color, important){
    try{
      if(!el) return;
      if(color){
        if(important) el.style.setProperty('background-color', color, 'important');
        else el.style.backgroundColor = color;
      } else {
        el.style.removeProperty('background-color');
      }
    }catch(e){}
  }

  function processCalendarOnce(){
    try{
      // Ensure headerColor is computed now (in case it wasn't earlier)
      computeHeaderColor();
      var nodes = document.querySelectorAll('#calendarGrid [data-date], #scrollCalendarContainer [data-date]');
      for(var i=0;i<nodes.length;i++){
        try{
          var cell = nodes[i];
          var dateKey = cell.getAttribute('data-date');
          if(!dateKey) continue;
          var d = new Date(dateKey);
          var isWeekend = (d.getDay() === 0 || d.getDay() === 6);
          var alertVal = (window.dayAlerts && typeof dayAlerts === 'object') ? dayAlerts[dateKey] : 0;

          // find day label element (text node like "4", "11")
          var dayLabel = null;
          var allDesc = cell.querySelectorAll('*');
          for(var j=0;j<allDesc.length;j++){
            var el = allDesc[j];
            var t = (el.textContent||'').trim();
            if(/^\d{1,2}$/.test(t)){
              dayLabel = el; break;
            }
          }
          // choose fallback visual root
          var targetRoot = cell.firstElementChild || cell;

          // build ancestor chain from dayLabel up to cell (max 5 nodes)
          var chain = [];
          if(dayLabel){
            var cur = dayLabel;
            var count = 0;
            while(cur && cur !== cell && count < 5){
              chain.push(cur);
              cur = cur.parentElement;
              count++;
            }
            if(cur === cell) chain.push(cell);
          } else {
            // fallback: prefer known inner wrappers
            var pref = cell.querySelector('.entries-container, .entry-container, .day-inner, .cell-inner, .day-wrapper');
            if(pref) chain.push(pref);
            chain.push(targetRoot);
          }

          // Trim chain to unique nodes
          var seen = new Set();
          chain = chain.filter(function(n){ if(!n) return false; if(seen.has(n)) return false; seen.add(n); return true; });

          if(alertVal === 1){
            // apply yellow alert inline with important on chain nodes, but avoid nodes likely colored
            for(var k=0;k<chain.length;k++){
              if(!isLikelyColored(chain[k])) setInlineBg(chain[k],'#fffef1', true);
            }
            cell.setAttribute('data-toto-applied','alert-yellow');
          } else if(alertVal === 2){
            for(var k=0;k<chain.length;k++){
              if(!isLikelyColored(chain[k])) setInlineBg(chain[k],'#ecfaff', true);
            }
            cell.setAttribute('data-toto-applied','alert-blue');
          } else if(isWeekend){
            // apply weekend color derived from headerColor to first ancestor in chain that is not likely colored
            var applied = false;
            for(var k=0;k<chain.length;k++){
              var node = chain[k];
              if(!isLikelyColored(node)){
                setInlineBg(node, '#fdfdfd', false);
                applied = true;
                break;
              }
            }
            if(!applied){
              setInlineBg(cell, '#fdfdfd', false);
            }
            cell.setAttribute('data-toto-applied','weekend-grey');
          } else {
            // weekday: clear any background we set on chain nodes (but only if not likely colored)
            for(var k=0;k<chain.length;k++){
              var node = chain[k];
              if(!isLikelyColored(node)) setInlineBg(node,'', false);
            }
            cell.removeAttribute('data-toto-applied');
          }
        }catch(e){}
      }
    }catch(e){ console.error('toto v8 error', e); }
  }

  // Debounced scheduling and observers
  var t = null;
  function schedule(){ if(t) clearTimeout(t); t = setTimeout(processCalendarOnce, 60); }

  if(document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function(){ schedule(); setTimeout(schedule, 180); });
  } else {
    schedule();
  }
  window.addEventListener('load', function(){ schedule(); setTimeout(schedule, 380); });

  function attachObserver(){
    var cal = document.getElementById('calendarGrid') || document.getElementById('calendarG') || document.getElementById('scrollCalendarContainer');
    if(!cal) return;
    try{
      var obs = new MutationObserver(function(){ schedule(); });
      obs.observe(cal, { childList: true, subtree: true, attributes: true, attributeFilter: ['class','style'] });
      cal._toto_v8_obs = obs;
    }catch(e){}
  }
  attachObserver();
  setTimeout(attachObserver, 220);
  setTimeout(attachObserver, 840);

  window._toto_apply_v8 = processCalendarOnce;
})();
</script>
<!-- END TOTO: Weekend + Alert targeted ancestor-chain patch v8 -->


<!-- Minimal disk-backed Save/Load (simple and reliable) -->
<script>
(function(){
  function gatherAppState(){
    const state = {};
    try{
      if (window.appState !== undefined) state.appState = window.appState;
      if (window.dayAlerts !== undefined) state.dayAlerts = window.dayAlerts;
      if (window.calendarEntries !== undefined) state.calendarEntries = window.calendarEntries;
      if (window.entries !== undefined) state.entries = window.entries;
      // snapshot localStorage keys likely used by the app
      state._localStorageSnapshot = {};
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        if (/cal|calendar|entry|event|state|alerts/i.test(k)) {
          try{ state._localStorageSnapshot[k] = JSON.parse(localStorage.getItem(k)); }catch(e){ state._localStorageSnapshot[k] = localStorage.getItem(k); }
        }
      }
    }catch(e){ console.warn('gatherAppState failed', e); }
    return state;
  }

  function applyLoadedState(data){
    try{
      if (!data) return;
      if (data._localStorageSnapshot){
        for (const k in data._localStorageSnapshot){
          try{ localStorage.setItem(k, typeof data._localStorageSnapshot[k] === 'string' ? data._localStorageSnapshot[k] : JSON.stringify(data._localStorageSnapshot[k])); }catch(e){ localStorage.setItem(k, data._localStorageSnapshot[k]); }
        }
      }
      if (data.appState !== undefined) window.appState = data.appState;
      if (data.dayAlerts !== undefined) window.dayAlerts = data.dayAlerts;
      if (data.calendarEntries !== undefined) window.calendarEntries = data.calendarEntries;
      if (data.entries !== undefined) window.entries = data.entries;
      // Refresh UI if possible
      if (typeof window.renderCalendar === 'function') try{ window.renderCalendar(); }catch(e){};
      if (typeof window.refreshUI === 'function') try{ window.refreshUI(); }catch(e){};
      if (typeof window.applyDayAlertEffects === 'function') try{ window.applyDayAlertEffects(); }catch(e){};
      console.log('Loaded state applied.');
    }catch(e){ console.warn('applyLoadedState failed', e); }
  }

  window.saveStateAsJSON = function(){
    try{
      const obj = gatherAppState();
      const text = JSON.stringify(obj, null, 2);
      const blob = new Blob([text], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'calendar_state.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      console.log('Exported state to calendar_state.json');
    }catch(e){ console.warn('saveStateAsJSON failed', e); }
  };

  window.loadStateFromJSONFile = function(file){
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const obj = JSON.parse(e.target.result);
        applyLoadedState(obj);
        alert('State loaded from file. UI refreshed.');
        try{ if (typeof saveToStorage === 'function') { saveToStorage(); console.log('Called app saveToStorage() after loading JSON'); } }catch(e){console.warn(e);}
      }catch(err){
        alert('Failed to parse JSON file.');
      }
    };
    reader.readAsText(file);
  };

  // Create small UI buttons (non-invasive)
  document.addEventListener('DOMContentLoaded', function(){
    const wrapper = document.createElement('div');
    wrapper.style.position = 'fixed';
    wrapper.style.right = '12px';
    wrapper.style.bottom = '12px';
    wrapper.style.zIndex = 99999;
    wrapper.style.display = 'flex';
    wrapper.style.flexDirection = 'column';
    wrapper.style.gap = '8px';

    const btnSave = document.createElement('button');
    btnSave.textContent = 'Save JSON';
    btnSave.style.padding = '6px 10px';
    btnSave.style.borderRadius = '8px';
    btnSave.style.border = '1px solid rgba(0,0,0,0.08)';
    btnSave.onclick = function(){ window.saveStateAsJSON(); };

    const btnLoad = document.createElement('button');
    btnLoad.textContent = 'Load JSON';
    btnLoad.style.padding = '6px 10px';
    btnLoad.style.borderRadius = '8px';
    btnLoad.style.border = '1px solid rgba(0,0,0,0.08)';
    btnLoad.onclick = function(){
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json,application/json';
      input.onchange = function(){ if (input.files && input.files[0]) window.loadStateFromJSONFile(input.files[0]); };
      input.click();
    };

    wrapper.appendChild(btnSave);
    wrapper.appendChild(btnLoad);
    document.body.appendChild(wrapper);
  });
})(); // end IIFE
</script>


<!-- IMPROVED PERSISTENCE: IndexedDB full-localStorage snapshot + manual JSON export/import -->
<script>
(function(){
  const DB_NAME = 'calendar-persistence-db';
  const STORE = 'state';
  function openDB(){
    return new Promise((res, rej)=>{
      const req = indexedDB.open(DB_NAME, 1);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);
      };
      req.onsuccess = ()=> res(req.result);
      req.onerror = ()=> res(null);
    });
  }
  async function saveToIndexedDB(jsonText){
    try{
      const db = await openDB();
      if (!db) return false;
      const tx = db.transaction(STORE, 'readwrite');
      tx.objectStore(STORE).put(jsonText, 'latest');
      return await new Promise((res, rej)=>{ tx.oncomplete = ()=> res(true); tx.onerror = ()=> res(false); });
    }catch(e){ console.warn('saveToIndexedDB failed', e); return false; }
  }
  async function loadFromIndexedDB(){
    try{
      const db = await openDB();
      if (!db) return null;
      const tx = db.transaction(STORE, 'readonly');
      const req = tx.objectStore(STORE).get('latest');
      return await new Promise((res, rej)=>{ req.onsuccess = ()=> { try{ res(req.result ? JSON.parse(req.result) : null); }catch(e){ res(null);} }; req.onerror = ()=> res(null); });
    }catch(e){ console.warn('loadFromIndexedDB failed', e); return null; }
  }

  function gatherAppStateFull(){
    const state = {};
    try{
      if (window.appState !== undefined) state.appState = window.appState;
      if (window.dayAlerts !== undefined) state.dayAlerts = window.dayAlerts;
      if (window.calendarEntries !== undefined) state.calendarEntries = window.calendarEntries;
      if (window.entries !== undefined) state.entries = window.entries;
      state._localStorageFull = {};
      for (let i=0;i<localStorage.length;i++){
        const k = localStorage.key(i);
        try{ state._localStorageFull[k] = localStorage.getItem(k); }catch(e){}
      }
    }catch(e){ console.warn('gatherAppStateFull failed', e); }
    return state;
  }

  function applyLoadedStateFull(data){
    try{
      if (!data) return;
      if (data._localStorageFull) {
        for (const k in data._localStorageFull) {
          try{ localStorage.setItem(k, data._localStorageFull[k]); }catch(e){};
        }
      }
      if (data.appState !== undefined) window.appState = data.appState;
      if (data.dayAlerts !== undefined) window.dayAlerts = data.dayAlerts;
      if (data.calendarEntries !== undefined) window.calendarEntries = data.calendarEntries;
      if (data.entries !== undefined) window.entries = data.entries;
      const tryCall = (name)=>{ try{ if (typeof window[name] === 'function') { window[name](); console.log('Called', name); } }catch(e){ console.warn('call',name,'failed',e); } };
      ['renderCalendar','refreshUI','applyDayAlertEffects','initCalendar','initializeApp','buildCalendar','generateScrollCalendar','setupCalendar'].forEach(tryCall);
      window.dispatchEvent(new CustomEvent('full-state-applied', {detail: data}));
      console.log('Full state applied and UI refresh attempted');
    }catch(e){ console.warn('applyLoadedStateFull failed', e); }
  }

  window.saveStateAsJSON = function(){
    try{
      const obj = gatherAppStateFull();
      const text = JSON.stringify(obj, null, 2);
      try{ saveToIndexedDB(text); }catch(e){}
      const blob = new Blob([text], {type: 'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'calendar_state.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
      console.log('Exported state to calendar_state.json and saved snapshot to IndexedDB');
      try{ if (typeof saveToStorage === 'function') { saveToStorage(); console.log('Called app saveToStorage() for native persistence'); } }catch(e){console.warn(e);}
    }catch(e){ console.warn('saveStateAsJSON failed', e); }
  };

  window.loadStateFromJSONFile = function(file){
    const reader = new FileReader();
    reader.onload = function(e){
      try{
        const obj = JSON.parse(e.target.result);
        applyLoadedStateFull(obj);
        try{ saveToIndexedDB(JSON.stringify(obj)); }catch(e){};
        alert('State loaded from file. UI refreshed.');
        try{ if (typeof saveToStorage === 'function') { saveToStorage(); console.log('Called app saveToStorage() after loading JSON'); } }catch(e){console.warn(e);}
      }catch(err){
        alert('Failed to parse JSON file.');
      }
    };
    reader.readAsText(file);
  };

  document.addEventListener('DOMContentLoaded', async function(){
    try{
      const data = await loadFromIndexedDB();
      if (data) {
        applyLoadedStateFull(data);
        console.log('Auto-loaded state from IndexedDB on DOMContentLoaded');
      }
    }catch(e){ console.warn('autoload on DOMContentLoaded failed', e); }
  });

  window.addEventListener('beforeunload', function(){
    try{
      const txt = JSON.stringify(gatherAppStateFull());
      try{ saveToIndexedDB(txt); }catch(e){};
    }catch(e){}
  });

})(); // end IIFE
</script>

</body>
</html>